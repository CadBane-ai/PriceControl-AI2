# 4. Data Models

## User
* **Purpose:** Represents an end-user of the application. This model stores authentication information, subscription status, and links to other data like conversation history.
* **Key Attributes:**
    * `id`: `string` - Unique identifier for the user (e.g., a UUID).
    * `email`: `string` - The user's login email, which must be unique.
    * `passwordHash`: `string` - The securely hashed password for authentication.
    * `stripeCustomerId`: `string` (nullable) - The user's unique ID in the Stripe system, linking them to their billing information.
    * `subscriptionStatus`: `enum ('free' | 'pro')` - The user's current subscription tier, which controls usage limits and upgrade prompts.
    * `planExpiresAt`: `Date` (nullable) - When the current paid period ends; used to reconcile webhook delays and support proactive downgrade messaging.
    * `createdAt`: `Date` - Timestamp of when the user account was created.
    * `updatedAt`: `Date` - Timestamp of the last update to the user record.
### TypeScript Interface
```typescript
export interface User {
  id: string;
  email: string;
  stripeCustomerId: string | null;
  subscriptionStatus: 'free' | 'pro';
  planExpiresAt: Date | null;
  createdAt: Date;
  updatedAt: Date;
}
```

## Conversation
* **Purpose:** Represents a single, distinct chat session between a user and the AI. It acts as a container for all messages exchanged within that session and allows users to maintain separate contexts for different topics.
* **Relationships:** A `User` can have many `Conversations`. Each `Conversation` belongs to exactly one `User`.
* **Key Attributes:**
    * `id`: `string` - A unique identifier for the conversation.
    * `userId`: `string` - A foreign key that links this conversation to the `User` who initiated it.
    * `title`: `string` - A short, descriptive title for the conversation, which can be auto-generated from the first user query (e.g., "SEC Filings for TSLA").
    * `createdAt`: `Date` - Timestamp of when the conversation was started.
    * `updatedAt`: `Date` - Timestamp of when the last message was added.
### TypeScript Interface
```typescript
import type { User } from './user';

export interface Conversation {
  id: string;
  userId: User['id'];
  title: string;
  createdAt: Date;
  updatedAt: Date;
}
```

## Message
* **Purpose:** Represents a single turn within a `Conversation`, containing the text from either the user or the AI assistant. A collection of messages, ordered by time, forms the complete chat history.
* **Relationships:** A `Conversation` can have many `Messages`. Each `Message` belongs to exactly one `Conversation`.
* **Key Attributes:**
    * `id`: `string` - A unique identifier for the message.
    * `conversationId`: `string` - A foreign key that links this message to its parent `Conversation`.
    * `role`: `enum ('user' | 'assistant')` - Specifies whether the message was sent by the user or generated by the AI.
    * `content`: `text` - The actual text content of the message.
    * `createdAt`: `Date` - Timestamp of when the message was created.
### TypeScript Interface
```typescript
import type { Conversation } from './conversation';

export interface Message {
  id: string;
  conversationId: Conversation['id'];
  role: 'user' | 'assistant';
  content: string;
  createdAt: Date;
}
```

## ToolCallLog
* **Purpose:** To create an immutable audit trail of every time the AI assistant uses a tool (e.g., `web.fetch`). This is critical for compliance with data source terms, debugging issues, and ensuring the data governance rules are being followed.
* **Relationships:** A `Message` from the assistant can be associated with one or more `ToolCallLogs`. Each log is also linked to the `User` and `Conversation` for easy querying.
* **Key Attributes:**
    * `id`: `string` - A unique identifier for the log entry.
    * `conversationId`: `string` - Foreign key linking to the `Conversation`.
    * `toolName`: `string` - The name of the tool that was called (e.g., 'web.fetch').
    * `toolInput`: `json` - The parameters the LLM passed to the tool.
    * `status`: `enum ('success' | 'failure')` - Indicates if the tool executed successfully.
    * `createdAt`: `Date` - Timestamp of when the tool call occurred.
### TypeScript Interface
```typescript
import type { Conversation } from './conversation';

export interface ToolCallLog {
  id: string;
  conversationId: Conversation['id'];
  toolName: string;
  toolInput: Record<string, any>;
  status: 'success' | 'failure';
  createdAt: Date;
}
```

## PasswordResetToken
* **Purpose:** Supports the self-service password recovery flow by storing hashed one-time tokens with expirations.
* **Relationships:** Belongs to a `User`. Multiple tokens can exist concurrently but all are invalidated when one is consumed. Tokens are removed automatically after expiration via scheduled cleanup or background jobs.
* **Key Attributes:**
    * `id`: `string` - Unique identifier for the token row.
    * `userId`: `string` - Foreign key linking to the associated `User`.
    * `tokenHash`: `string` - Secure hash of the token sent via email.
    * `expiresAt`: `Date` - Expiration timestamp (e.g., 60 minutes after issuance).
    * `consumedAt`: `Date` (nullable) - Timestamp when the token was used.
    * `createdAt`: `Date` - Audit timestamp when the token was generated.
### TypeScript Interface
```typescript
import type { User } from './user';

export interface PasswordResetToken {
  id: string;
  userId: User['id'];
  tokenHash: string;
  expiresAt: Date;
  consumedAt: Date | null;
  createdAt: Date;
}
```

## UsageCounter (Redis Backed)
* **Purpose:** Tracks rolling daily usage totals for freemium gating without persisting every request to Postgres. Keys combine the `userId` with the UTC day.
* **Shape:** Documented TypeScript type for the payload returned by the Usage Service.
```typescript
export interface UsageSummary {
  plan: 'free' | 'pro';
  usedToday: number;
  dailyLimit: number;
  resetAt: Date; // midnight UTC for the next reset
}
```
* **Notes:** Backed by Upstash Redis. Counts increment inside `/api/ai` and are read via `GET /api/usage` to power the header badge, mobile account sheet, and chat footer hints in the refreshed UI spec.

---
