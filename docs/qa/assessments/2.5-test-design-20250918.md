# Test Design: Story 2.5 – Implement Data Source Registry & Governed web.fetch Tool

Date: 2025-09-18
Designer: Quinn (Test Architect)

## Test Strategy Overview
- Total test scenarios: 12
- Unit tests: 6 (50%)
- Integration tests: 6 (50%)
- E2E tests: 0 (0%) – scope is backend service/tooling; integration coverage exercises request/response boundaries
- Priority distribution: P0: 7, P1: 4, P2: 1, P3: 0

## Test Scenarios by Acceptance Criteria

### AC1: `/datasources.yml` exists and is parsable
| ID | Level | Priority | Test | Justification | Mitigates |
|----|-------|----------|------|---------------|-----------|
| 2.5-UNIT-001 | Unit | P1 | Parse happy-path YAML returns normalized registry objects | Ensures config aligns with schema and future tests have reliable fixtures | DATA-001 |
| 2.5-UNIT-002 | Unit | P0 | Malformed YAML or missing `sources` throws descriptive error without defaulting to allow-all | Prevents silent failures that could disable guard | DATA-001 |
| 2.5-UNIT-003 | Unit | P1 | Duplicate `id` entries surface conflict error | Stops registry drift that could mask governance bugs | DATA-001 |

### AC2: Guard function validates registry access
| ID | Level | Priority | Test | Justification | Mitigates |
|----|-------|----------|------|---------------|-----------|
| 2.5-UNIT-004 | Unit | P0 | `isAllowedSource` returns true for approved ID and respects `allow.host/path` patterns | Validates security-critical allow path | SEC-001 |
| 2.5-UNIT-005 | Unit | P0 | `isAllowedSource` returns false for unknown ID, case variants, and manual-review-only sources | Blocks bypass attempts and honors governance flags | SEC-001, SEC-002 |
| 2.5-UNIT-006 | Unit | P2 | Cache layer invalidates on TTL or file mtime change | Protects against stale data while keeping tests fast | TECH-001 |

### AC3–AC6: Governed `web.fetch` tool behavior
| ID | Level | Priority | Test | Justification | Mitigates |
|----|-------|----------|------|---------------|-----------|
| 2.5-INT-001 | Integration | P0 | Allowed `sourceId` resolves through registry, performs fetch, and returns content payload | Validates end-to-end happy path | SEC-001 |
| 2.5-INT-002 | Integration | P0 | Disallowed `sourceId` short-circuits with `{ error: "Source not allowed" }` and never calls outbound fetch | Confirms guard enforces deny path | SEC-001 |
| 2.5-INT-003 | Integration | P0 | Request supplying raw URL parameter is rejected with validation error | Prevents clients from bypassing ID-only contract | SEC-001 |
| 2.5-INT-004 | Integration | P0 | Simulated 302 redirect to disallowed host triggers re-validation and abort | Ensures redirect handling closes common exfil vector | SEC-002 |
| 2.5-INT-005 | Integration | P1 | Manual-review-flagged source returns explicit governance error and audit entry | Verifies governance metadata is enforced and observable | SEC-002, OPS-001 |
| 2.5-INT-006 | Integration | P1 | Update `datasources.yml` mid-test, clear cache, and confirm new allow/deny state takes effect | Exercises cache invalidation in deployed flow | TECH-001 |

## Risk Coverage
- P0 scenarios `2.5-UNIT-004`, `2.5-UNIT-005`, `2.5-INT-001` through `2.5-INT-004` directly mitigate the two high security risks (SEC-001, SEC-002).
- DATA-001 mitigation is covered by schema validation and duplicate detection tests (`2.5-UNIT-001` to `2.5-UNIT-003`).
- TECH-001 receives both unit-level cache validation (`2.5-UNIT-006`) and integration coverage (`2.5-INT-006`).
- OPS-001 is exercised by verifying audit logging in `2.5-INT-005`.

## Recommended Execution Order
1. Run P0 unit tests (`2.5-UNIT-004`, `2.5-UNIT-005`) to catch security regressions immediately.
2. Execute remaining P0 scenarios (`2.5-INT-001`–`2.5-INT-004`) with HTTP/mocking harness to validate guard + tool integration.
3. Run P1 coverage, starting with YAML schema/unit (`2.5-UNIT-001`, `2.5-UNIT-003`) then governance observability integration (`2.5-INT-005`).
4. Execute cache refresh tests (`2.5-UNIT-006`, `2.5-INT-006`) and the remaining P2 scenario for non-critical optimizations.

## Coverage Gaps
- None identified; every acceptance criterion and high-severity risk has at least one automated scenario.

## Tooling & Data Requirements
- Fixture YAML files (valid, malformed, duplicate ID, manual-review) stored under `apps/web/__tests__/fixtures/datasources/`.
- HTTP layer mocked via `undici` or `node-fetch` spy to assert no network call on deny paths and to simulate redirects.
- Structured logger mock to assert audit events during denial scenarios.

## Maintenance Notes
- Centralize registry schema definition in the transparency service so both runtime code and tests consume a single source of truth.
- Provide helpers for loading fixtures and resetting the cache to keep integration tests deterministic.
- Document governance log formats to stabilize assertions as additional tools come online.

---
Test design matrix: docs/qa/assessments/2.5-test-design-20250918.md
P0 tests identified: 7
