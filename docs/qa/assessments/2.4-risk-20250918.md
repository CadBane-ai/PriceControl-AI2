# Risk Profile: Story 2.4 – Implement Dual-Model Selection

Date: 2025-09-18
Analyst: Quinn (Test Architect)

## Executive Summary
Story 2.4 introduces a dual-model selection capability spanning frontend state, shared configuration, and backend routing to OpenRouter. The primary risks center on enforcing the Cerebras-only provider restriction while allowing user-selected model IDs, maintaining configuration parity between the client and API, and avoiding regressions that default every request to the high-cost reasoning model. Overall residual risk is **Moderate (Overall Score: 68)** with two high-risk items that require targeted mitigations and regression tests.

## Risk Matrix
| Risk ID  | Description                                                                                     | Probability | Impact | Score | Priority |
|----------|-------------------------------------------------------------------------------------------------|-------------|--------|-------|----------|
| SEC-001  | Model parameter not validated server-side, allowing requests to bypass the Cerebras restriction | Medium (2)  | High (3) | 6   | High     |
| PERF-001 | Default selection bug sends all traffic to the reasoning model, causing latency and quota drain | Medium (2)  | High (3) | 6   | High     |
| TECH-001 | Frontend model list drifts from backend expectations, causing 400s or fallback failures         | Medium (2)  | Medium (2) | 4 | Medium   |
| TECH-002 | Client state desync/hydration issues send stale `model`/`mode` values to API                     | Medium (2)  | Medium (2) | 4 | Medium   |
| OPS-001  | Missing telemetry for selected model/mode hides production misrouting                           | Low (1)     | Medium (2) | 2 | Low      |

## Detailed Risk Register

### SEC-001 – Missing Server-Side Validation for Model Parameter
- **Category:** Security
- **Affected Components:** `apps/web/app/api/ai/route.ts`, OpenRouter call wrapper
- **Detection Method:** Manual inspection of story requirements vs. existing API validation
- **Rationale:** Allowing the client to pass an arbitrary model ID without server validation could let users select non-Cerebras providers or unsupported models, breaching contractual guarantees.
- **Mitigations:**
  - Validate the incoming `model` against the enumerated IDs in `OPENROUTER_MODEL_GROUPS` (shared module import).
  - Fallback to `resolveModelForMode` when validation fails; log the rejection.
  - Maintain unit tests asserting rejection of unknown model IDs and continued enforcement of `{ provider: { only: ["Cerebras"] } }`.
  - Consider feature flagging newly added models until regression tested.
- **Residual Risk After Mitigation:** Low (2) × Medium (2) = 4 (Medium).

### PERF-001 – Reasoning Model Default Regression
- **Category:** Performance / Cost
- **Affected Components:** Model picker state management, chat request body construction
- **Rationale:** Reasoning models (e.g., Llama 3.3 70B) incur substantially higher latency and cost. A state default bug or regression in `resolveModelForMode` could route all traffic to the expensive model.
- **Mitigations:**
  - Add unit tests for `resolveModelForMode` covering default modes and invalid inputs.
  - Add component/integration test ensuring the initial selection is the instruct default.
  - Monitor production metrics (latency, model usage mix) with alerts on sudden reasoning-model spikes.
  - Provide admin override/feature flag to temporarily disable reasoning model if needed.
- **Residual Risk After Mitigation:** Medium (2) × Medium (2) = 4 (Medium).

### TECH-001 – Configuration Drift Between Frontend and Backend
- **Category:** Technical
- **Affected Components:** `apps/web/lib/models.ts`, chat client hooks, API route
- **Rationale:** If the frontend configuration diverges (e.g., stale bundle, missed deploy, tree-shaking), the client might send IDs the server cannot resolve, leading to 400 responses or fallback loops.
- **Mitigations:**
  - Export shared model metadata from a single source (e.g., shared module imported by both client and server).
  - Add integration test hitting `/api/ai` with each configured model ID to assert 200 responses.
  - Add CI guard verifying the dropdown options align with the `OPENROUTER_MODELS` defaults.
- **Residual Risk After Mitigation:** Low (1) × Medium (2) = 2 (Low).

### TECH-002 – Hydration and State Synchronization Failures
- **Category:** Technical
- **Affected Components:** Header component, Zustand store (or equivalent), SSR boundaries
- **Rationale:** The picker lives in a header rendered across client/SSR boundaries. Hydration mismatches or stale state snapshots could cause the displayed model to differ from the value sent to the API.
- **Mitigations:**
  - Use a single client-side store with hydration-safe initialization.
  - Add component test verifying selection updates state and rendered label.
  - Add integration test to ensure the POST payload matches the selected option.
  - Consider persisting selection per conversation to avoid race conditions.
- **Residual Risk After Mitigation:** Low (1) × Medium (2) = 2 (Low).

### OPS-001 – Lack of Telemetry for Model Selection
- **Category:** Operational
- **Affected Components:** Observability pipeline, logging within `/api/ai`
- **Rationale:** Without logging which model/mode pairs are used, misrouting incidents (e.g., everyone suddenly on reasoning) may go unnoticed until costs spike.
- **Mitigations:**
  - Add structured logs and metrics (model ID, mode, response time, error rate).
  - Set alerts for anomalies (e.g., >60% reasoning usage per hour).
  - Include dashboards in runbooks for release QA.
- **Residual Risk After Mitigation:** Low (1) × Low (1) = 1 (Minimal).

## Overall Story Risk Score
- **Base Score:** 100
- **Deductions:**
  - High risks (2 × 10) = 20
  - Medium risks (2 × 5) = 10
  - Low risks (1 × 2) = 2
- **Overall Residual Score:** **68 / 100 (Moderate)**

## Risk-Based Testing Strategy
1. **Critical Focus (High Risks)**
   - Expand integration tests verifying server-side validation rejects unknown models (mitigates SEC-001).
   - Add regression coverage for default selection and `resolveModelForMode` paths (mitigates PERF-001).
2. **Secondary Focus (Medium Risks)**
   - Component test ensuring picker reflects and updates state consistently (TECH-002).
   - Cross-check test ensuring every configured model ID produces a successful `/api/ai` response (TECH-001).
3. **Operational Safeguards**
   - Smoke test verifying structured logging emits model/mode fields (OPS-001).
   - Recommend synthetic monitoring hitting both instruct and reasoning flows post-deploy.

## Deployment & Monitoring Recommendations
- Use feature flags or gradual rollout for exposing new model groups.
- Monitor OpenRouter quota usage and response latency immediately after deployment.
- Prepare a rollback/runbook to disable reasoning options if metrics spike or validation fails.

## Accepted / Deferred Risks
- No risks accepted without mitigation; reassess after implementation if additional threats emerge during QA or security review.

---
Risk profile: docs/qa/assessments/2.4-risk-20250918.md
