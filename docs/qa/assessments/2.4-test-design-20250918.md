# Test Design: Story 2.4 – Implement Dual-Model Selection

Date: 2025-09-18
Designer: Quinn (Test Architect)

## Test Strategy Overview
- Total test scenarios: 12
- Unit tests: 5 (41.7%)
- Integration tests: 6 (50.0%)
- E2E tests: 1 (8.3%)
- Priority distribution: P0: 4, P1: 6, P2: 2, P3: 0

## Test Scenarios by Acceptance Criteria

### AC1: Model picker renders in chat header
| ID             | Level | Priority | Test                                                            | Justification |
|----------------|-------|----------|-----------------------------------------------------------------|---------------|
| 2.4-INT-001    | Integration | P1 | Chat header renders `ModelPicker` with dropdown trigger visible | Confirms component wiring inside header layout |
| 2.4-E2E-001    | E2E   | P2       | User opens chat view and sees picker present on initial load    | Smoke-level validation to catch deployment config issues |

### AC2: Picker populated from `OPENROUTER_MODEL_GROUPS`
| ID             | Level | Priority | Test                                                                      | Justification |
|----------------|-------|----------|---------------------------------------------------------------------------|---------------|
| 2.4-UNIT-001   | Unit  | P1       | `OPENROUTER_MODEL_GROUPS` exports expected group metadata                 | Guards against accidental config pruning |
| 2.4-INT-002    | Integration | P1 | `ModelPicker` displays grouped options with correct labels/tooltips       | Ensures UI consumes config correctly |

### AC3: Active model indication & tooltips
| ID             | Level | Priority | Test                                                            | Justification |
|----------------|-------|----------|-----------------------------------------------------------------|---------------|
| 2.4-INT-003    | Integration | P2 | Selecting option updates label and tooltip content              | Prevents UX regressions affecting clarity |

### AC4: Selection passed to `/api/ai`
| ID             | Level | Priority | Test                                                                      | Justification |
|----------------|-------|----------|---------------------------------------------------------------------------|---------------|
| 2.4-UNIT-002   | Unit  | P0       | `resolveModelForMode` returns expected defaults per mode                  | Protects against PERF-001 high-risk regression |
| 2.4-UNIT-003   | Unit  | P0       | `findOptionById` returns matching option metadata (mode/tooltips)         | Critical for default inference and validation |
| 2.4-INT-004    | Integration | P0 | Chat send handler includes selected `model` and `mode` in POST payload    | Ensures frontend-server contract holds |

### AC5: Backend routes request to selected model with Cerebras guard
| ID             | Level | Priority | Test                                                                      | Justification |
|----------------|-------|----------|---------------------------------------------------------------------------|---------------|
| 2.4-INT-005    | Integration | P0 | `/api/ai` with explicit `model` invokes OpenRouter client with `{ provider: { only: ["Cerebras"] } }` | Mitigates SEC-001 high-risk scenario |
| 2.4-INT-006    | Integration | P1 | `/api/ai` without `model` but with `mode` falls back via `resolveModelForMode` | Verifies graceful defaults |
| 2.4-UNIT-004   | Unit  | P1       | Validation rejects unknown model IDs and falls back to default            | Adds defense-in-depth for SEC-001 |

### AC6: Authentication remains enforced
| ID             | Level | Priority | Test                                                            | Justification |
|----------------|-------|----------|-----------------------------------------------------------------|---------------|
| 2.4-INT-007    | Integration | P1 | Unauthenticated POST to `/api/ai` returns 401 (no session bypass) | Confirms existing auth guard intact |

### AC7: Automated tests added for frontend & backend logic
| ID             | Level | Priority | Test                                                            | Justification |
|----------------|-------|----------|-----------------------------------------------------------------|---------------|
| 2.4-UNIT-005   | Unit  | P2       | `ModelPicker` state hook initializes to instruct default        | Complements integration coverage with fast feedback |

## Risk Coverage
- Tests 2.4-INT-005 and 2.4-UNIT-004 directly mitigate **SEC-001** (server-side validation and Cerebras enforcement).
- Tests 2.4-UNIT-002 and 2.4-INT-004 address **PERF-001** by guarding default routing and payload fidelity.
- Tests 2.4-INT-002/003 and 2.4-UNIT-003 cover **TECH-002** by ensuring state/UI sync.
- Test 2.4-INT-006 supports **TECH-001** by validating shared defaults on the server.

## Recommended Execution Order
1. P0 unit tests (`2.4-UNIT-002`, `2.4-UNIT-003`, `2.4-UNIT-004`) – fast guardrails for validation and defaults.
2. P0 integration test (`2.4-INT-004`, `2.4-INT-005`) – verify end-to-end contract adherence.
3. Remaining P1 integration/unit tests to ensure UI wiring and auth enforcement.
4. E2E and P2 tests to confirm user experience and non-critical assurances.

## Coverage Gaps
- None. Every acceptance criterion mapped to at least one automated scenario.

## Tooling & Fixtures
- Mock OpenRouter client to capture provider payloads without outbound calls.
- Provide fixtures for `OPENROUTER_MODEL_GROUPS` to assert expected structure.
- Use component testing harness (e.g., React Testing Library + user-event) for dropdown interactions.
- Integration tests via Next.js route tester or supertest to simulate session/no-session requests.
- E2E test can reuse existing Playwright harness, gated behind feature flag if necessary.

## Maintenance Notes
- Keep `OPENROUTER_MODEL_GROUPS` fixture in sync with production config via shared import to avoid drift.
- Structure integration tests to iterate over available model IDs, easing future model additions.
- Document telemetry expectations (model, mode fields) so logs can be asserted in integration tests.

---
Test design matrix: docs/qa/assessments/2.4-test-design-20250918.md
P0 tests identified: 4
