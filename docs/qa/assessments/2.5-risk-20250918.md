# Risk Profile: Story 2.5 – Implement Data Source Registry & Governed web.fetch Tool

Date: 2025-09-18
Analyst: Quinn (Test Architect)

## Executive Summary
Story 2.5 introduces the first governance layer in front of outbound LLM tooling. The dominant risks concentrate on preventing bypasses of the allow-listed registry, ensuring the YAML schema cannot disable the guard at runtime, and guaranteeing the new caching layer does not mask configuration changes. Residual risk is **Moderate (Overall Score: 68)** driven by two high-severity security items that must be closed with rigorous validation, redirect handling, and regression tests around the `web.fetch` contract.

## Risk Matrix
| Risk ID | Description | Probability | Impact | Score | Priority |
|---------|-------------|-------------|--------|-------|----------|
| SEC-001 | `web.fetch` accepts raw URLs or unvalidated IDs that skip the registry guard | Medium (2) | High (3) | 6 | High |
| SEC-002 | HTTP redirects or malformed registry entries allow fetching disallowed hosts | Medium (2) | High (3) | 6 | High |
| DATA-001 | Corrupted or misconfigured `datasources.yml` causes guard failure or unsafe defaults | Medium (2) | Medium (2) | 4 | Medium |
| TECH-001 | Cache invalidation defects serve stale registry data after governance updates | Medium (2) | Medium (2) | 4 | Medium |
| OPS-001 | Missing auditing/alerting hides repeated denials or unexpected outbound attempts | Low (1) | Medium (2) | 2 | Low |

## Detailed Risk Register

### SEC-001 – Registry Bypass via Raw URL Input
- **Category:** Security
- **Affected Components:** `apps/web/app/api/ai/route.ts`, planned `apps/web/lib/governance.ts`, tool registration glue
- **Detection Method:** Requirement/code review; check existing chat request schema
- **Rationale:** If the tool accepts a URL parameter (or trusts the client-provided `sourceId` without lookup) the guard can be bypassed, enabling arbitrary web access and potential data exfiltration.
- **Mitigations:**
  - Restrict tool schema to accept only `sourceId` values that resolve to registry entries; disallow direct URLs.
  - Add unit tests verifying `isAllowedSource` rejects IDs not present (including case sensitivity).
  - Add integration tests ensuring tool rejects payloads that already contain full URLs.
  - Log and rate-limit repeated rejections to surface probing attempts.
- **Residual Risk After Mitigation:** Low (1) × High (3) = 3 (Low).

### SEC-002 – Redirects or Wildcards Escaping Allow List
- **Category:** Security
- **Affected Components:** HTTP fetch wrapper, registry schema (wildcards, manual review flags)
- **Detection Method:** Architecture inspection and review of datasource patterns
- **Rationale:** Many allowed hosts use wildcards. Without enforcing redirect targets and normalizing hostnames, an attacker could craft an allowed URL that redirects to a forbidden domain, or abuse overly permissive wildcards.
- **Mitigations:**
  - Resolve redirects manually and re-validate final host before consuming the response.
  - Limit wildcard matching (e.g., `*.ir.*`) with explicit regex validation and optional manual approval workflow.
  - Store and enforce governance flags (`require_manual_review`) so risky sources require human approval before fetch.
  - Add integration tests stubbing redirect responses to confirm the guard performs secondary validation and aborts.
- **Residual Risk After Mitigation:** Low (1) × High (3) = 3 (Low).

### DATA-001 – YAML Corruption or Schema Drift Disables Guard
- **Category:** Data Governance
- **Affected Components:** `datasources.yml`, transparency service loader/cache
- **Detection Method:** Config review; absence of schema validation today
- **Rationale:** Manual edits to the YAML can introduce typos, duplicates, or missing sections that break parsing or fall back to permissive defaults, leaving the guard returning `false` for valid sources or `true` for invalid ones.
- **Mitigations:**
  - Define a Zod/Yup schema for the registry format and run validation on load with descriptive errors.
  - Provide CI check that loads the YAML and fails on schema violations before deploy.
  - Implement safe defaults (`isAllowedSource` returns `false` when parsing fails) with structured alerts.
  - Add unit tests covering malformed YAML, duplicate IDs, and governance flag combinations.
- **Residual Risk After Mitigation:** Low (1) × Medium (2) = 2 (Low).

### TECH-001 – Cache Staleness After Registry Updates
- **Category:** Technical
- **Affected Components:** Transparency service cache implementation, filesystem watchers
- **Detection Method:** Design review; compare caching plan to update cadence
- **Rationale:** Caching the registry reduces I/O but risks serving outdated allow-lists if the cache is not invalidated when `datasources.yml` changes, undermining emergency block/allow operations.
- **Mitigations:**
  - Implement TTL-based cache with explicit busting when file mtime changes.
  - Expose an admin hook/test helper to clear the cache during tests and deployments.
  - Instrument metrics/logs exposing cache hits vs. reloads for observability.
  - Add unit tests verifying cache refresh after file modification and integration tests covering dynamic updates.
- **Residual Risk After Mitigation:** Low (1) × Medium (2) = 2 (Low).

### OPS-001 – Insufficient Auditing of Denied Fetch Attempts
- **Category:** Operational
- **Affected Components:** Logging layer, transparency service observability
- **Detection Method:** Review of current `/api/ai` logging; no governance logs exist yet
- **Rationale:** Without structured logs or alerts for denied `sourceId`s, security incidents or user frustration may go unnoticed, and SOC teams lack trail for compliance.
- **Mitigations:**
  - Emit structured audit log entries for every denial with user ID, source ID, and reason.
  - Add counters/metrics with alert thresholds for repeated denials or failures.
  - Provide tamper-evident storage (e.g., append-only log sink) for compliance.
- **Residual Risk After Mitigation:** Low (1) × Low (1) = 1 (Minimal).

## Overall Story Risk Score
- **Base Score:** 100
- **Deductions:**
  - High risks: 2 × 10 = 20
  - Medium risks: 2 × 5 = 10
  - Low risks: 1 × 2 = 2
- **Overall Residual Score:** **68 / 100 (Moderate)**

## Risk-Based Testing Strategy
1. **Security First (High Risks)** – Prioritize tests that enforce ID-only inputs, detect raw URL payloads, and verify redirect re-validation to block bypass attempts.
2. **Configuration Safety (Medium Risks)** – Add schema-validation unit tests for YAML corruption and integration tests simulating cache refresh after file edits.
3. **Operational Assurance (Low Risks)** – Include smoke tests/assertions that denial paths emit structured logs and metrics hooks, enabling SOC monitoring.

## Deployment & Monitoring Recommendations
- Ship with feature flag disable switch for `web.fetch` to halt outbound access if governance anomalies arise.
- Add synthetic monitoring to exercise allowed and denied fetches in staging with alerts wired to security/on-call rotations.
- Document governance update runbook covering YAML edits, cache invalidation, and post-change verification steps.

## Accepted / Deferred Risks
- No risks accepted without mitigation. Reassess redirect handling once additional tools are onboarded to ensure defenses scale.

---
Risk profile: docs/qa/assessments/2.5-risk-20250918.md
