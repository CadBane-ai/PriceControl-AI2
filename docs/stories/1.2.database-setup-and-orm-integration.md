# Story 1.2: Database Setup & ORM Integration

## Status
Approved

## Story
**As a** developer,
**I want** to set up the Neon database and integrate Drizzle ORM into the Next.js application,
**so that** we can persist and manage user data.

## Acceptance Criteria
1. A new Neon Postgres project is created.
2. The Next.js application is configured with environment variables to connect to the Neon database.
3. Drizzle ORM is installed and configured in the project.
4. An initial database schema for a `users` table (including fields for id, email, hashed password) is created using Drizzle.
5. A Drizzle migration is successfully run against the Neon database, creating the `users` table.

## Tasks / Subtasks
- [ ] Dependencies & Setup (AC: 2–3)
  - [ ] Add dependencies in `apps/web`: `drizzle-orm`, `drizzle-kit`, `pg`.
  - [ ] Create `apps/web/drizzle.config.ts` with schema paths and connection using `DATABASE_URL`.
  - [ ] Add scripts in `apps/web/package.json`:
    - [ ] `"drizzle:generate"` → generate SQL migrations from schema
    - [ ] `"drizzle:migrate"` → apply migrations to Neon
  - [ ] Ensure `DATABASE_URL` is read from env (no secrets committed).
- [ ] Schema (AC: 4)
  - [ ] Create `apps/web/db/schema/users.ts` with columns matching the architecture specification:
    - [ ] `id` (UUID, default generated)
    - [ ] `email` (unique, not null)
    - [ ] `password_hash` (text, not null; expose as `passwordHash` in TypeScript if desired)
    - [ ] `stripe_customer_id` (nullable text)
    - [ ] `subscription_status` (enum defaulting to `free`)
    - [ ] `plan_expires_at` (nullable timestamp)
    - [ ] `created_at`, `updated_at` (timestamps with default now())
  - [ ] Create `apps/web/db/client.ts` using `drizzle-orm/node-postgres` with `pg` and `DATABASE_URL`.
  - [ ] Export a typed `db` instance for use in routes.
- [ ] Migrations (AC: 5)
  - [ ] Run `pnpm drizzle:generate` to produce migration files.
  - [ ] Run `pnpm drizzle:migrate` to apply migrations to Neon.
  - [ ] Verify `users` table exists in Neon (via Neon console or psql).
- [ ] Documentation (AC: 2–5)
  - [ ] Update root `README.md` with minimal DB setup and migration instructions.
  - [ ] Document required env vars for local dev (do not add `.env.example` yet; that is a later story).

## Dev Notes
- Source of truth
  - PRD Epic 1.2 defines the scope and AC for DB setup and ORM.
  - Architecture → Database Schema (`docs/architecture/9-database-schema.md`) defines the full `users` table shape; align column names and defaults with that document, even if some fields (e.g., Stripe) are populated later.
- Technology
  - Database: Neon Postgres (Architecture 3-Tech Stack).
  - ORM: Drizzle ORM with Node Postgres driver (`pg`) for server runtime.
  - Migrations: `drizzle-kit` generated SQL applied to Neon.
- Environment
  - Use `DATABASE_URL` with SSL (Neon often requires `?sslmode=require`).
  - Do not commit secrets; set env locally and in Vercel project settings.
- Implementation outline
  - Place schema in `apps/web/db/schema/*` and client in `apps/web/db/client.ts`.
  - `drizzle.config.ts` in `apps/web` points to schema globs and migration output directory (e.g., `./drizzle`).
  - Add `drizzle:generate` and `drizzle:migrate` scripts to `apps/web/package.json`.
  - Keep UI and mock APIs unchanged in this story; wiring will happen in auth stories.

- Traceability
  - Aligns with AGENT_HANDOFF.md → Next Steps → (3) Database & Migrations.
  - Mirrors PRD 6-epic-1-foundation-user-onboarding.md → Story 1.2 AC 1–5.
  - Conforms to Architecture 3-Tech Stack (Neon Postgres, Drizzle) and 9-Database Schema (foundation for users; other tables later).

### Testing
- Minimal verification for this story:
  - Run generate and migrate; confirm the `users` table exists in Neon.
  - Optional: add a tiny Node script in `apps/web/scripts/` or use a temporary route locally to run a simple `select count(*) from users;` via `db` to verify connectivity (remove before commit if not needed).
- Follow Architecture Testing Strategy: functional DB tests will be added when API endpoints are implemented.

## Change Log
| Date | Version | Description | Author |
|---|---|---|---|
| 2025-09-14 | 0.1 | Initial draft of Story 1.2 for DB setup and Drizzle integration | Scrum Master |
| 2025-09-14 | 0.2 | PO validation complete, status set to Approved; added traceability notes | Product Owner |

## Dev Agent Record
### Agent Model Used
{{agent_model_name_version}}

### Debug Log References

### Completion Notes List

- Added Drizzle configuration (`apps/web/drizzle.config.ts`) and DB client (`apps/web/db/client.ts`).
- Created initial `users` schema (`apps/web/db/schema/users.ts`).
- Updated `apps/web/package.json` with `drizzle:generate` and `drizzle:migrate` scripts; added dependencies `drizzle-orm`, `drizzle-kit`, and `pg`.
- Updated `README.md` with migration instructions and notes on `DATABASE_URL`.
- Migrations not executed here due to environment constraints (no Neon `DATABASE_URL` available in sandbox). Devs can run from `apps/web` with the commands provided once `DATABASE_URL` is set.

### File List

- Added: `apps/web/drizzle.config.ts`
- Added: `apps/web/db/schema/users.ts`
- Added: `apps/web/db/client.ts`
- Updated: `apps/web/package.json` (scripts + deps)
- Updated: `apps/web/pnpm-lock.yaml` (after local install)
- Updated: `README.md` (DB setup)

## QA Results

2025-09-18 – Manual risk and traceability review logged in `docs/qa/assessments/epic1-story-1.1-1.7-risk-traceability-20250918.md`. High-risk focus areas: DATA-1.2 (schema drift) and TECH-1.2 (env misconfiguration). Mitigation requires CI migration dry-run and runtime guardrails before release.
