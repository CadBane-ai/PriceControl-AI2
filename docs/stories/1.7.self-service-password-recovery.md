# Story 1.7: Self-Service Password Recovery

## Status
Ready for Dev

## Story
**As a** user who has forgotten their password,
**I want** a secure, self-service flow to request a reset link and set a new password,
**so that** I can regain access without contacting support.

## Acceptance Criteria
1. The login screen links to a `/forgot-password` route that renders a form (email field with validation, submit button) built with the shared auth card layout.
2. Submitting the form calls the password-reset request endpoint, shows an in-place success state confirming the destination email, and offers a "Try again" action plus navigation back to `/login`.
3. The success state and primary form both surface a "Continue with Google" button using the shared OAuth component so alternative sign-in remains available.
4. A `/reset-password` route accepts a `token` query parameter; missing or invalid tokens redirect users back to `/forgot-password` with an error toast.
5. The reset form collects a new password and confirmation, enforces matching values, calls the reset endpoint, and on success routes the user to `/login` with a confirmation toast.
6. Authentication error handling is centralized in an `(auth)/error` page that interprets common NextAuth error codes (e.g., OAuth failures) and provides quick links back to `/login` or retrying Google sign-in.

## Tasks / Subtasks
- [ ] Database & Models
  - [ ] Add Drizzle schema for `passwordResetTokens` with hashed token, expiry, user reference, and consumed flag.
  - [ ] Introduce helper queries to create, validate, and consume tokens.
- [ ] Rate Limiting & Email Delivery
  - [ ] Integrate Upstash Redis limiter to throttle password reset requests per user/IP.
  - [ ] Configure Resend email template for reset link delivery with signed token URL.
- [ ] API Endpoints
  - [ ] Implement `POST /api/auth/forgot-password` to validate email, generate token, persist hash, enqueue email, and return 202 always.
  - [ ] Implement `POST /api/auth/reset-password` to validate token, update password hash, consume token, revoke sessions, and return 204.
- [ ] UI Flows
  - [ ] Build `/forgot-password` page using shared auth layout with success state and Google CTA.
  - [ ] Build `/reset-password` page that validates `token` query parameter, enforces matching passwords, and surfaces error/success toasts.
  - [ ] Add `(auth)/error` route that maps NextAuth error codes (including OAuth failures) to friendly messaging and navigation actions.
  - [ ] Link login page button to `/forgot-password` and ensure Google CTA parity across auth screens.
- [ ] Testing
  - [ ] API tests covering rate limit behavior, token lifecycle, invalid/expired tokens, and session revocation.
  - [ ] UI tests ensuring forgot/reset flows render correct states, handle invalid tokens, and redirect to login with confirmation toast.
- [ ] Documentation & Ops
  - [ ] Document required env vars: `RESEND_API_KEY`, `PASSWORD_RESET_TOKEN_SECRET`, `UPSTASH_REDIS_REST_URL`, `UPSTASH_REDIS_REST_TOKEN`.
  - [ ] Update README with forgot/reset flow instructions and email prerequisites.

## Dev Notes
- Architecture references: docs/architecture/6-components.md#password-reset-service and docs/architecture/8-core-workflows.md#password-reset-flow.
- Token storage should hash the token using a secure algorithm (e.g., SHA-256) before persistence; plaintext tokens must never be stored.
- Reset endpoint must invalidate existing sessions (via NextAuth) after password change to prevent hijacking.
- Email copy should avoid confirming whether an email exists; always present success state.
- Consider background job or queue abstraction for email dispatch; synchronous send is acceptable for MVP if guarded by retries.

## Testing
- Manual
  - From `/login`, navigate to `/forgot-password`, request reset, verify success state, and email receipt (via Resend logs in non-production).
  - Visit `/reset-password?token=<valid>` to set a new password → confirm redirect to `/login` with toast.
  - Visit `/reset-password` without token or with invalid token → expect redirect back with error toast.
  - Attempt multiple requests in quick succession → ensure rate limiting message appears after threshold.
- Automated
  - Unit/integration tests for token creation/consumption logic and API endpoints.
  - UI test covering forgot/reset happy path and invalid token redirect.

## QA Results
TBD – pending implementation.

2025-09-18 – Provisional risk and traceability assessment stored in `docs/qa/assessments/epic1-story-1.1-1.7-risk-traceability-20250918.md`. High-priority risks: SEC-1.7 (token security), OPS-1.7 (email delivery), PERF-1.7 (rate limiting). These must be addressed during implementation review.

## PO Validation
PO Review Date: 2025-09-17
Decision: Approved
Notes:
- Aligns with PRD v4 Story 1.7 and architecture password reset workflow.
- Ensure coordination with Story 1.5/1.6 for provider lists and shared auth layout consistency.

## Dev Agent Record
### Agent Model Used
{{agent_model_name_version}}

### Debug Log References

### Completion Notes List

### File List

## Change Log
- 2025-09-17: Initial draft created from PRD Epic 1 Story 1.7 aligning with architecture v4 password reset service.
