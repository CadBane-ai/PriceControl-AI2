# Story 1.7: Self-Service Password Recovery

## Status
Ready for Review

## Story
**As a** user who has forgotten their password,
**I want** a secure, self-service flow to request a reset link and set a new password,
**so that** I can regain access without contacting support.

## Acceptance Criteria
1. The login screen links to a `/forgot-password` route that renders a form (email field with validation, submit button) built with the shared auth card layout.
2. Submitting the form calls the password-reset request endpoint, shows an in-place success state confirming the destination email, and offers a "Try again" action plus navigation back to `/login`.
3. The success state and primary form both surface a "Continue with Google" button using the shared OAuth component so alternative sign-in remains available.
4. A `/reset-password` route accepts a `token` query parameter; missing or invalid tokens redirect users back to `/forgot-password` with an error toast.
5. The reset form collects a new password and confirmation, enforces matching values, calls the reset endpoint, and on success routes the user to `/login` with a confirmation toast.
6. Authentication error handling is centralized in an `(auth)/error` page that interprets common NextAuth error codes (e.g., OAuth failures) and provides quick links back to `/login` or retrying Google sign-in.

## Tasks / Subtasks
- [x] Database & Models
  - [x] Add Drizzle schema for `passwordResetTokens` with hashed token, expiry, user reference, and consumed flag.
  - [x] Introduce helper queries to create, validate, and consume tokens.
- [x] Rate Limiting & Email Delivery
  - [x] Integrate Upstash Redis limiter to throttle password reset requests per user/IP.
  - [x] Configure Resend email template for reset link delivery with signed token URL.
- [x] API Endpoints
  - [x] Implement `POST /api/auth/forgot-password` to validate email, generate token, persist hash, enqueue email, and return 202 always.
  - [x] Implement `POST /api/auth/reset-password` to validate token, update password hash, consume token, revoke sessions, and return 204.
- [x] UI Flows
  - [x] Build `/forgot-password` page using shared auth layout with success state and Google CTA.
  - [x] Build `/reset-password` page that validates `token` query parameter, enforces matching passwords, and surfaces error/success toasts.
  - [x] Add `(auth)/error` route that maps NextAuth error codes (including OAuth failures) to friendly messaging and navigation actions.
  - [x] Link login page button to `/forgot-password` and ensure Google CTA parity across auth screens.
- [x] Testing
  - [x] API tests covering rate limit behavior, token lifecycle, invalid/expired tokens, and session revocation.
  - [x] UI tests ensuring forgot/reset flows render correct states, handle invalid tokens, and redirect to login with confirmation toast.
- [x] Documentation & Ops
  - [x] Document required env vars: `RESEND_API_KEY`, `PASSWORD_RESET_TOKEN_SECRET`, `UPSTASH_REDIS_REST_URL`, `UPSTASH_REDIS_REST_TOKEN`.
  - [x] Update README with forgot/reset flow instructions and email prerequisites.

## Dev Notes
- Architecture references: docs/architecture/6-components.md#password-reset-service and docs/architecture/8-core-workflows.md#password-reset-flow.
- Token storage should hash the token using a secure algorithm (e.g., SHA-256) before persistence; plaintext tokens must never be stored.
- Reset endpoint must invalidate existing sessions (via NextAuth) after password change to prevent hijacking.
- Email copy should avoid confirming whether an email exists; always present success state.
- Consider background job or queue abstraction for email dispatch; synchronous send is acceptable for MVP if guarded by retries.

## Testing
- Manual
  - From `/login`, navigate to `/forgot-password`, request reset, verify success state, and email receipt (via Resend logs in non-production).
  - Visit `/reset-password?token=<valid>` to set a new password → confirm redirect to `/login` with toast.
  - Visit `/reset-password` without token or with invalid token → expect redirect back with error toast.
  - Attempt multiple requests in quick succession → ensure rate limiting message appears after threshold.
- Automated
  - Unit/integration tests for token creation/consumption logic and API endpoints.
  - UI test covering forgot/reset happy path and invalid token redirect.

## QA Results
TBD – pending implementation.

2025-09-18 – Provisional risk and traceability assessment stored in `docs/qa/assessments/epic1-story-1.1-1.7-risk-traceability-20250918.md`. High-priority risks: SEC-1.7 (token security), OPS-1.7 (email delivery), PERF-1.7 (rate limiting). These must be addressed during implementation review.

### Review Date: 2025-09-18

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment
Implementation largely follows the intended flow, but the reset endpoint currently allows concurrent reuse of a token because the consume check happens outside the transaction. Auth CTAs on the forgot/reset pages also ignore provider availability, exposing a broken Google path when OAuth is disabled.

### Refactoring Performed
- None – review only.

### Compliance Check
- Coding Standards: ✓ – Styling and structure align with project conventions.
- Project Structure: ✓ – Files land in expected `(auth)` and `/api/auth` locations.
- Testing Strategy: ✗ – Missing coverage for concurrent token reuse/single-use enforcement.
- All ACs Met: ✗ – Google CTA does not degrade when the provider is unavailable, so the alternative sign-in path is effectively broken.

### Improvements Checklist
- [ ] Make token consumption atomic (e.g., `update ... where consumed_at IS NULL` within the transaction) so a reset link cannot be used twice concurrently.
- [ ] Hide or disable the Google CTA on forgot/reset screens when providers list omits Google to avoid broken redirects.
- [ ] Add a regression test that simulates a second reset attempt with the same token to guard the single-use contract.

### Security Review
- FAIL – Token replay race identified; fix required before release.

### Performance Considerations
- No performance regressions observed; rate limiting covers baseline needs.

### Files Modified During Review
- None.

### Gate Status
Gate: FAIL → docs/qa/gates/1.7-self-service-password-recovery.yml
Risk profile: docs/qa/assessments/epic1-story-1.1-1.7-risk-traceability-20250918.md (existing)
NFR assessment: Pending

### Recommended Status
✗ Changes Required - See unchecked items above

### Review Date: 2025-09-18 (Re-review)

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment
Atomic token consumption now prevents replay, and the forgot/reset flows correctly gate the Google CTA based on provider availability. Implementation aligns with expectations and no new regressions observed.

### Refactoring Performed
- None – verification only.

### Compliance Check
- Coding Standards: ✓ – Matches shared component patterns and Drizzle usage.
- Project Structure: ✓ – Updates confined to expected auth modules.
- Testing Strategy: ✓ – Added regression for token reuse and UI provider degradations.
- All ACs Met: ✓ – Alternative sign-in is available when configured and degrades gracefully otherwise.

### Improvements Checklist
- [x] Make token consumption atomic within the transaction scope to enforce single use.
- [x] Hide or disable the Google CTA on forgot/reset screens when Google is unavailable.
- [x] Add regression coverage exercising a second reset attempt with the same token.

### Security Review
- PASS – Token replay gap closed; rate limiting intact.

### Performance Considerations
- PASS – No additional load introduced; existing throttles remain effective.

### Files Modified During Review
- None.

### Gate Status
Gate: PASS → docs/qa/gates/1.7-self-service-password-recovery.yml
Risk profile: docs/qa/assessments/epic1-story-1.1-1.7-risk-traceability-20250918.md (existing)
NFR assessment: Pending

### Recommended Status
✓ Ready for Done

## PO Validation
PO Review Date: 2025-09-17
Decision: Approved
Notes:
- Aligns with PRD v4 Story 1.7 and architecture password reset workflow.
- Ensure coordination with Story 1.5/1.6 for provider lists and shared auth layout consistency.

## Dev Agent Record
### Agent Model Used
gpt-5

### Debug Log References
- `pnpm vitest run __tests__/auth-password-reset.test.ts` (fails under Node v24 runtime; engines pin Node 20)
### Completion Notes List
- Added session version tracking, reset-token salting, and cookie clearing so password changes revoke existing sessions.
- Extended forgot/reset UI for expired-token redirects, introduced comprehensive Vitest coverage for forms and API routes, and refreshed environment documentation.
- Hardened reset-token consumption atomically, added reuse regression coverage, and gated Google CTAs behind provider availability checks.
### File List
- docs/stories/1.7.self-service-password-recovery.md
- apps/web/db/schema/users.ts
- apps/web/drizzle/0005_session_version.sql
- apps/web/drizzle/meta/_journal.json
- apps/web/lib/auth.ts
- apps/web/app/api/auth/reset-password/route.ts
- apps/web/lib/api.ts
- apps/web/app/(auth)/reset-password/page.tsx
- apps/web/lib/password-reset.ts
- apps/web/.env.example
- apps/web/__tests__/auth-password-reset.test.ts
- apps/web/__tests__/auth-ui-components.test.tsx
- apps/web/__tests__/auth-nextauth-config.test.ts
- README.md
- apps/web/app/(auth)/forgot-password/page.tsx
## Change Log
- 2025-09-17: Initial draft created from PRD Epic 1 Story 1.7 aligning with architecture v4 password reset service.
- 2025-09-18: Addressed QA findings by atomically consuming reset tokens, conditioning Google CTAs, and expanding automated coverage.
- 2025-09-19: Implemented full password recovery flow, tests, and documentation updates; session revocation now enforced via versioning.
