# Story 1.6: Connect UI to Auth & Protect Routes

## Status
Ready for Review

## Story
**As a** user,
**I want** the signup and login forms to authenticate me and allow access to a protected dashboard,
**so that** I can use the app after signing in.

## Acceptance Criteria
1. The sign-up form posts to `/api/auth/register`, surfaces success and error toasts, and redirects to `/login` on success.
2. The login form calls `signIn("credentials", { email, password, redirect: false })`, handles success and failure without a full-page reload, and shows appropriate toasts.
3. After a successful sign-up or login (including OAuth flows), the user is redirected to `/dashboard` or the `next` query parameter target.
4. The `/dashboard` route uses NextAuth session checks to enforce authentication, redirecting unauthenticated visitors to `/login`.
5. The login experience renders a Google sign-in button via NextAuth and surfaces provider-specific error messages when Google OAuth fails.
6. Logging out triggers NextAuth `signOut`, clears the session cookie, and returns the user to the login page.

## Tasks / Subtasks
- [x] Connect signup flow (AC: 1)
  - [x] Call `/api/auth/register` from the signup form, handling 201/400/409/500 responses.
  - [x] Display success and error toasts that match PRD copy.
  - [x] Redirect successful signups to `/login`.
- [x] Connect login flow (AC: 2–3)
  - [x] Invoke `signIn("credentials", { email, password, redirect: false })` and surface toast feedback without page reloads.
  - [x] Redirect successful logins to `/dashboard` or the `next` query parameter destination.
  - [x] Handle invalid credentials gracefully with generic messaging.
- [x] Enforce protected routes (AC: 4)
  - [x] Use NextAuth session checks (middleware and/or server components) to guard `/dashboard`, redirecting unauthenticated users to `/login` with `next` preserved.
  - [x] Ensure client-side `AuthGuard` reflects session state for UX polish.
- [x] Google provider UX (AC: 5)
  - [x] Fetch providers via `GET /api/auth/providers` and conditionally render the Google sign-in button.
  - [x] Display provider-specific error messaging via `(auth)/error` when OAuth failures occur.
- [x] Logout experience (AC: 6)
  - [x] Trigger `signOut` to clear session cookies and return users to `/login`.
  - [x] Add logout confirmation toast if it aligns with experience goals.
- [x] Documentation
  - [x] Update `README.md` with auth wiring overview, including `next` redirects and Google provider availability.
  - [x] Note any required environment variables or configuration toggles.

## Dev Notes
- Dependencies & Prior Work
  - Uses Story 1.4 registration endpoint and Story 1.5 NextAuth credentials flow. Ensure local envs (DATABASE_URL, NEXTAUTH_SECRET, NEXTAUTH_URL, GOOGLE_CLIENT_ID/SECRET) are set for testing.
- Protection approach
  - Middleware-based: matches patterns like `/dashboard` or `/((protected))/.*` and redirects to `/login` if no session.
  - Server layout-based: `getServerSession` in `app/(protected)/layout.tsx`; redirect when missing session.
  - Pick one as the primary; optionally keep both where appropriate.
- UX & Errors
  - Keep authentication error messages generic; do not disclose whether the email exists.
  - Provide success/error toasts for signup/login flows consistent with PRD copy.
  - Preserve the login redirect target if a user is bounced to login via the `next` parameter.
  - Render Google sign-in when the provider is available and surface provider-specific error messaging; defer deep OAuth failure UX to Story 1.7 if needed.

- Traceability
  - Aligns with AGENT_HANDOFF.md → Next Steps → (4) Authentication.
  - Mirrors PRD 6-epic-1-foundation-user-onboarding.md → Story 1.6 AC (connect UI to auth & protect routes).
  - Depends on Story 1.4 (registration) and 1.5 (login/session). Follows Story 1.3 (UI forms).

### Testing
- Manual flows
  - Signup success → success toast + redirect to `/login`; repeat same email → duplicate error toast.
  - Login with valid credentials → success toast + redirect to `/dashboard` (or `next` target); invalid → error toast without navigation.
  - Directly visiting `/dashboard` while logged out → redirected to `/login`.
  - Google button renders when provider envs exist; simulate Google failure to verify provider-specific error messaging.
  - Logout → session cleared, redirect to `/login`, optional toast displayed.
- Automated
  - Component tests covering toast rendering, `next` redirect handling, and Google button availability can be added as follow-up.

## Change Log
| Date | Version | Description | Author |
|---|---|---|---|
| 2025-09-14 | 0.1 | Initial draft for connecting UI to auth and protecting routes | Scrum Master |
| 2025-09-14 | 0.2 | PO validation complete, status set to Approved; added traceability notes | Product Owner |
| 2025-09-17 | 0.3 | Updated AC for toasts, `next` redirects, and Google provider UX per PRD v4 | Product Owner |
| 2025-09-18 | 0.4 | Reworked tasks to mirror PRD v4 Story 1.6 deliverables and clarify documentation expectations | Scrum Master |

## Dev Agent Record
### Agent Model Used
gpt-5.1-codex

### Debug Log References

- `pnpm vitest run --coverage=false --reporter verbose` (fails under Node v24; project tooling expects Node 20.x, so tests could not be executed locally.)
- `pnpm vitest run __tests__/auth-ui-components.test.tsx --coverage=false` (same Node 24.x engine mismatch prevents execution.)

### Completion Notes List

- Signup and login flows show toast feedback, redirect on success, and respect the `next` query parameter after authentication.
- Middleware now preserves the full requested location when redirecting unauthenticated users to `/login`.
- Added coverage tests for the AuthGuard and middleware behaviors.
- Top bar logout triggers a toast before dispatching `signOut`, and README documents Google OAuth env requirements.
- Login page now hides the Google sign-in button when the provider is unavailable and surfaces a message clarifying the missing env configuration. Added regression coverage for this scenario.

### File List

- Updated: `apps/web/components/auth-guard.tsx`
- Updated: `apps/web/components/dashboard/top-bar.tsx`
- Updated: `apps/web/middleware.ts`
- Updated: `apps/web/app/(auth)/login/page.tsx`
- Updated: `README.md`
- Updated: `apps/web/__tests__/auth-ui-components.test.tsx`
- Added: `apps/web/__tests__/auth-route-protection.test.tsx`

## QA Results

Decision: PASS

Summary
- Signup form posts to `/api/auth/register`, handles 400/409/500 with clear toasts, and redirects to `/login` on success.
- Login form uses NextAuth Credentials via `signIn('credentials', ...)`, redirects to `/dashboard` on success, and shows an error on invalid credentials.
- Middleware guards `/dashboard`, `/account`, and `/billing` using `next-auth/jwt` `getToken` and redirects unauthenticated users to `/login?next=...`.
- Logout uses `signOut({ callbackUrl: '/login' })` and session-based UI shows the authenticated user’s email.

Validation Steps (Manual)
1) Ensure envs are set locally: `DATABASE_URL`, `NEXTAUTH_SECRET`, `NEXTAUTH_URL`.
2) Register a user via `/signup` or `POST /api/auth/register`.
3) Login at `/login` with valid credentials → expect redirect to `/dashboard`; invalid → error.
4) Direct visit to `/dashboard` when logged out → redirect to `/login`.
5) Use the top bar menu to log out → redirected to `/login`; visiting `/dashboard` again redirects.
6) Authenticated state shows the email in the account menu.

Notes
- Middleware covers `/dashboard`, `/account`, `/billing`. Adjust `PROTECTED_PATHS` and `matcher` in `apps/web/middleware.ts` if scope changes.
- Client-side `AuthGuard` is retained as a secondary guard; primary enforcement is middleware.
- Re-test signup/login toasts, `next` redirects, and Google provider UX after implementing new acceptance criteria.

QA By: QA Agent
Date: 2025-09-15

2025-09-18 – See `docs/qa/assessments/epic1-story-1.1-1.7-risk-traceability-20250918.md` for expanded risk and trace mapping. Prioritize mitigation of SEC-1.6 (middleware coverage) and ensure `next` redirect scenarios are Playwright-tested.

---

Decision: FAIL (2025-09-19)

Summary
- Google Credentials button renders even when the provider is unavailable. Story AC5 requires conditional rendering based on `/api/auth/providers`. `apps/web/app/(auth)/login/page.tsx:105` still shows `<GoogleSignInButton>` regardless of the `googleAvailable` flag, so users see a non-functional Google entry point when the provider is misconfigured.
- Auth guard/middleware redirect flows verified via new unit tests; encoded `next` handling confirmed.
- Logout UX now emits toast confirmation before `signOut`.

Validation Steps (Manual/Static)
1) Force `/api/auth/providers` to return `{}` (e.g., disconnect Google credentials). The login card still displays the Google button (`apps/web/app/(auth)/login/page.tsx:101-112`), violating AC5.
2) Middleware and AuthGuard logic inspected; unit tests cover unauthenticated redirects with encoded destinations.
3) Documentation updates reviewed to ensure env requirements noted.

Notes
- Test suite currently cannot be executed in this environment because the repo enforces Node 20.x while the runner is Node 24.x; rerun `pnpm vitest run` under the supported runtime to confirm regression coverage.
- Recommend hiding or disabling the Google button when `googleAvailable` is false, and optionally surfacing a tooltip or alternative CTA.

QA By: Quinn (Test Architect)

---

Decision: PASS (2025-09-19)

Summary
- Login card now hides the Google button when `/api/auth/providers` omits a Google entry and surfaces an actionable message (`apps/web/app/(auth)/login/page.tsx:35-71`).
- Regression coverage added to ensure the provider check works (`apps/web/__tests__/auth-ui-components.test.tsx:104-142`).
- Middleware/AuthGuard redirect behavior remains unchanged and validated via existing tests.

Validation Steps (Manual/Static)
1) Reviewed login page logic to confirm conditional rendering (`googleAvailable && …`) and message when providers.google is absent.
2) Inspected updated Vitest to confirm negative-path expectations for the Google button.
3) Confirmed earlier redirect-focused tests untouched.

Notes
- Test suite still needs to be run under Node 20.x (`pnpm vitest run __tests__/auth-ui-components.test.tsx --coverage=false`) due to current Node 24.x mismatch.
- Consider adding user-visible retry guidance if the providers fetch fails (non-blocking).

QA By: Quinn (Test Architect)
