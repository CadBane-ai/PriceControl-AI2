# Story 1.6: Connect UI to Auth & Protect Routes

## Status
Review

## Story
**As a** user,
**I want** the signup and login forms to authenticate me and allow access to a protected dashboard,
**so that** I can use the app after signing in.

## Acceptance Criteria
1. Signup form calls `POST /api/auth/register` with email and password; duplicate and validation errors are handled with user-friendly messages.
2. Login form authenticates via NextAuth Credentials: `signIn('credentials', { email, password, redirect: false })`.
3. On successful login, the user is redirected to `/dashboard`; on invalid credentials, an error is shown without navigation.
4. The `/dashboard` route (and other protected pages) is guarded so unauthenticated users are redirected to `/login`.
5. A logout action ends the session and redirects to `/login`.
6. The `/dashboard` shows a minimal authenticated state (e.g., welcome message including the user’s email).

## Tasks / Subtasks
- [x] Wire Signup UI (AC: 1)
  - [x] Replace placeholder handler to call `/api/auth/register`.
  - [x] Show error messages for 400/409/500 accordingly.
  - [x] On success: redirect to `/login`.
- [x] Wire Login UI (AC: 2–3)
  - [x] Replace placeholder handler with `signIn('credentials', { email, password, redirect: false })`.
  - [x] On success: `router.push('/dashboard')`; on failure: show error.
- [x] Protect Routes (AC: 4)
  - [x] Implement `middleware.ts` to enforce auth on `/dashboard`, `/account`, and `/billing` using NextAuth jwt token.
  - [x] Keep client-side `AuthGuard` updated to use `useSession` (optional secondary guard).
- [x] Logout (AC: 5)
  - [x] Add logout button that calls `signOut({ callbackUrl: '/login' })`.
- [x] Dashboard Auth State (AC: 6)
  - [x] Display user email in the top bar.
- [x] Documentation
  - [x] Update README with the chosen protection approach (middleware vs server layout) and where to adjust route patterns.

## Dev Notes
- Dependencies & Prior Work
  - Uses Story 1.4 registration endpoint and Story 1.5 NextAuth credentials flow. Ensure local envs (DATABASE_URL, NEXTAUTH_SECRET, NEXTAUTH_URL) are set for testing.
- Protection approach
  - Middleware-based: matches patterns like `/dashboard` or `/((protected))/.*` and redirects to `/login` if no session.
  - Server layout-based: `getServerSession` in `app/(protected)/layout.tsx`; redirect when missing session.
  - Pick one as the primary; optionally keep both where appropriate.
- UX & Errors
  - Keep authentication error messages generic; do not disclose whether the email exists.
  - Preserve the login redirect target if a user is bounced to login (optional enhancement).

- Traceability
  - Aligns with AGENT_HANDOFF.md → Next Steps → (4) Authentication.
  - Mirrors PRD 6-epic-1-foundation-user-onboarding.md → Story 1.6 AC (connect UI to auth & protect routes).
  - Depends on Story 1.4 (registration) and 1.5 (login/session). Follows Story 1.3 (UI forms).

### Testing
- Manual flows
  - Signup success → redirected to `/login`; repeat same email → duplicate error.
  - Login with valid credentials → redirected to `/dashboard`; invalid → error toast/message.
  - Directly visiting `/dashboard` while logged out → redirected to `/login`.
  - Logout → redirected to `/login`; visiting `/dashboard` again redirects to `/login`.
  - Authenticated `/dashboard` displays welcome with user’s email.

## Change Log
| Date | Version | Description | Author |
|---|---|---|---|
| 2025-09-14 | 0.1 | Initial draft for connecting UI to auth and protecting routes | Scrum Master |
| 2025-09-14 | 0.2 | PO validation complete, status set to Approved; added traceability notes | Product Owner |

## Dev Agent Record
### Agent Model Used
{{agent_model_name_version}}

### Debug Log References

### Completion Notes List

- Signup form now posts to `/api/auth/register` and handles success/duplicate/validation/server errors.
- Login form uses `signIn('credentials', ...)` and redirects to `/dashboard` on success.
- Added `apps/web/middleware.ts` to protect `/dashboard`, `/account`, and `/billing` with JWT token check; redirects to `/login` when unauthenticated.
- Updated `AuthGuard` to rely on NextAuth `useSession` instead of mock localStorage.
- Top bar now shows the authenticated user’s email and uses NextAuth `signOut` for logout.

### File List

- Updated: `apps/web/app/(auth)/signup/page.tsx`
- Updated: `apps/web/app/(auth)/login/page.tsx`
- Updated: `apps/web/components/auth-guard.tsx`
- Added: `apps/web/middleware.ts`
- Updated: `apps/web/components/dashboard/top-bar.tsx`

## QA Results

Decision: PASS

Summary
- Signup form posts to `/api/auth/register`, handles 400/409/500 with clear toasts, and redirects to `/login` on success.
- Login form uses NextAuth Credentials via `signIn('credentials', ...)`, redirects to `/dashboard` on success, and shows an error on invalid credentials.
- Middleware guards `/dashboard`, `/account`, and `/billing` using `next-auth/jwt` `getToken` and redirects unauthenticated users to `/login?next=...`.
- Logout uses `signOut({ callbackUrl: '/login' })` and session-based UI shows the authenticated user’s email.

Validation Steps (Manual)
1) Ensure envs are set locally: `DATABASE_URL`, `NEXTAUTH_SECRET`, `NEXTAUTH_URL`.
2) Register a user via `/signup` or `POST /api/auth/register`.
3) Login at `/login` with valid credentials → expect redirect to `/dashboard`; invalid → error.
4) Direct visit to `/dashboard` when logged out → redirect to `/login`.
5) Use the top bar menu to log out → redirected to `/login`; visiting `/dashboard` again redirects.
6) Authenticated state shows the email in the account menu.

Notes
- Middleware covers `/dashboard`, `/account`, `/billing`. Adjust `PROTECTED_PATHS` and `matcher` in `apps/web/middleware.ts` if scope changes.
- Client-side `AuthGuard` is retained as a secondary guard; primary enforcement is middleware.

QA By: QA Agent
Date: 2025-09-15
