# Story 1.4: User Registration API Endpoint

## Status
Approved

## Story
**As a** developer,
**I want** to create a secure API endpoint for user registration,
**so that** new users can be created and stored in the database.

## Acceptance Criteria
1. A new API route is created at `/api/auth/register`.
2. The endpoint accepts a POST request with an email and password.
3. The endpoint validates the incoming data.
4. The password is securely hashed before being stored.
5. A new user record is successfully created in the `users` table in the Neon database.
6. A success response is returned upon user creation.
7. An appropriate error response is returned if the user already exists or if there is an error.

## Tasks / Subtasks
- [x] Dependencies & Setup (AC: 2–4)
  - [x] Ensure `zod` is available for request validation.
  - [x] Add `bcryptjs` for password hashing if not installed.
- [x] Validation (AC: 2–3)
  - [x] Add register schema in `apps/web/lib/validators.ts` (email, password rules).
- [x] API Route (AC: 1–7)
  - [x] Implement `apps/web/app/api/auth/register/route.ts` with `POST` handler:
    - [x] Parse and validate input using Zod.
    - [x] Check for existing user by email (unique constraint).
    - [x] Hash password with `bcryptjs` and insert user via Drizzle.
    - [x] Return 201 on success; 409 on duplicate; 400/500 on validation/other errors.
- [x] Documentation
  - [x] Add brief README note about the route and payload shape.

## Dev Notes
- Alignment
  - PRD Story 1.4 specifies creating the registration endpoint prior to wiring UI (Story 1.6).
  - Uses the `users` table and Drizzle setup from Story 1.2.
- Security
  - Never log raw passwords; use `bcryptjs` with a safe salt rounds setting (e.g., 10).
  - Unique email constraint should be enforced both at app-level (check before insert) and in DB.
- Non-goals
  - No NextAuth session issuance here; that’s Story 1.5 (login & session).
  - No UI wiring; that’s Story 1.6.

### Testing
- Manual test via cURL or REST client acceptable for this story:
  - `POST /api/auth/register` with `{ "email": "test@example.com", "password": "..." }`.
  - Expect 201 on first attempt; 409 on duplicate.
- Unit test of validation logic may be added later with broader test scaffolding.

## Change Log
| Date | Version | Description | Author |
|---|---|---|---|
| 2025-09-14 | 0.1 | Initial draft for user registration API endpoint | Scrum Master |
| 2025-09-14 | 0.2 | PO validation complete, status set to Approved; added traceability notes | Product Owner |

## Dev Agent Record
### Agent Model Used
gpt-5-codex

### Debug Log References

- `pnpm test` (fails under Node 24 in sandbox; Vitest exits early without summary — rerun locally on Node 20.x).

### Completion Notes List

- Validated the `/api/auth/register` route meets Story 1.4 requirements (Zod validation, duplicate guard, bcrypt hashing, Drizzle insert).
- Added Vitest coverage in `apps/web/__tests__/api-auth-register.test.ts` for success, duplicate, invalid payload, and unsupported method scenarios.
- Documented the registration endpoint contract and status codes in `apps/web/README.md`.

### File List

- Added: `apps/web/__tests__/api-auth-register.test.ts`
- Updated: `apps/web/README.md`

- Traceability
  - Aligns with AGENT_HANDOFF.md → Next Steps → (4) Authentication.
  - Mirrors PRD 6-epic-1-foundation-user-onboarding.md → Story 1.4 AC 1–7.
  - Depends on Story 1.2 (DB & Drizzle) for `users` schema and DB connectivity.
## QA Results
Decision: PASS

Summary
- Route validates input with `registerSchema`, normalizes email, hashes passwords with bcrypt, and persists via Drizzle (apps/web/app/api/auth/register/route.ts:25).
- Duplicate submissions return 409 via pre-insert lookup, and successful responses expose sanitized user info only (apps/web/app/api/auth/register/route.ts:29).
- API contract and status codes are documented for frontend consumers (apps/web/README.md:94).

Validation
- `pnpm test` (Node 20.x) — passes including new `/api/auth/register` suite.

Risks / Follow-ups
- A race between the duplicate check and insert could still surface a 500 on unique constraint violations; consider catching the database error and mapping it to 409 to harden under load.

