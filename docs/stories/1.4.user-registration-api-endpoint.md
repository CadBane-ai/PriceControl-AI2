# Story 1.4: User Registration API Endpoint

## Status
Approved

## Story
**As a** developer,
**I want** to create a secure API endpoint for user registration,
**so that** new users can be created and stored in the database.

## Acceptance Criteria
1. A new API route is created at `/api/auth/register`.
2. The endpoint accepts a POST request with an email and password.
3. The endpoint validates the incoming data.
4. The password is securely hashed before being stored.
5. A new user record is successfully created in the `users` table in the Neon database.
6. A success response is returned upon user creation.
7. An appropriate error response is returned if the user already exists or if there is an error.

## Tasks / Subtasks
- [ ] Dependencies & Setup (AC: 2–4)
  - [ ] Ensure `zod` is available for request validation.
  - [ ] Add `bcryptjs` for password hashing if not installed.
- [ ] Validation (AC: 2–3)
  - [ ] Add register schema in `apps/web/lib/validators.ts` (email, password rules).
- [ ] API Route (AC: 1–7)
  - [ ] Implement `apps/web/app/api/auth/register/route.ts` with `POST` handler:
    - [ ] Parse and validate input using Zod.
    - [ ] Check for existing user by email (unique constraint).
    - [ ] Hash password with `bcryptjs` and insert user via Drizzle.
    - [ ] Return 201 on success; 409 on duplicate; 400/500 on validation/other errors.
- [ ] Documentation
  - [ ] Add brief README note about the route and payload shape.

## Dev Notes
- Alignment
  - PRD Story 1.4 specifies creating the registration endpoint prior to wiring UI (Story 1.6).
  - Uses the `users` table and Drizzle setup from Story 1.2.
- Security
  - Never log raw passwords; use `bcryptjs` with a safe salt rounds setting (e.g., 10).
  - Unique email constraint should be enforced both at app-level (check before insert) and in DB.
- Non-goals
  - No NextAuth session issuance here; that’s Story 1.5 (login & session).
  - No UI wiring; that’s Story 1.6.

### Testing
- Manual test via cURL or REST client acceptable for this story:
  - `POST /api/auth/register` with `{ "email": "test@example.com", "password": "..." }`.
  - Expect 201 on first attempt; 409 on duplicate.
- Unit test of validation logic may be added later with broader test scaffolding.

## Change Log
| Date | Version | Description | Author |
|---|---|---|---|
| 2025-09-14 | 0.1 | Initial draft for user registration API endpoint | Scrum Master |
| 2025-09-14 | 0.2 | PO validation complete, status set to Approved; added traceability notes | Product Owner |

## Dev Agent Record
### Agent Model Used
{{agent_model_name_version}}

### Debug Log References

### Completion Notes List

- Implemented registration route at `/api/auth/register` with Zod validation, duplicate check, bcrypt hashing, and Drizzle insert.
- Added `bcryptjs` dependency and exported a `registerSchema` alias for server-side validation reuse.
- Route returns proper HTTP statuses: 201 (created), 409 (exists), 400 (invalid), 500 (server error).

### File List

- Added: `apps/web/app/api/auth/register/route.ts`
- Updated: `apps/web/lib/validators.ts` (export `registerSchema`)
- Updated: `apps/web/package.json` (add `bcryptjs`)
- Updated: `apps/web/pnpm-lock.yaml`

- Traceability
  - Aligns with AGENT_HANDOFF.md → Next Steps → (4) Authentication.
  - Mirrors PRD 6-epic-1-foundation-user-onboarding.md → Story 1.4 AC 1–7.
  - Depends on Story 1.2 (DB & Drizzle) for `users` schema and DB connectivity.
## QA Results
Decision: PASS

Summary
- API route implemented at `/api/auth/register` with Next.js route handler.
- Validates `email` and `password` via Zod (`registerSchema`).
- Checks for existing user by email before insert and relies on DB unique constraint.
- Hashes password using `bcryptjs` (salt rounds: 10) before persisting.
- Inserts via Drizzle ORM and returns 201 with `{ user: { id, email } }`.
- Returns 409 for duplicates, 400 for invalid input, 500 for server errors.

Preconditions to validate end-to-end
- Neon `DATABASE_URL` configured locally and in Vercel.
- Story 1.2 migrations applied; `users` table exists (and `pgcrypto` extension enabled if using `gen_random_uuid()`).

Manual test (examples)
- Success:
  - `curl -X POST http://localhost:3000/api/auth/register \
     -H 'Content-Type: application/json' \
     -d '{"email":"test@example.com","password":"password123"}'`
  - Expect: 201 and `{ user: { id, email } }`
- Duplicate:
  - Re-run the same request; expect: 409 and `{ error: "User already exists" }`.
- Invalid:
  - Missing fields or invalid email; expect: 400 with Zod error details.

Risks / Notes
- Email normalization not applied (e.g., `.toLowerCase()`/trim). Not required by AC; recommend adding in a follow-up to avoid case-variant duplicates.
- No rate limiting yet (covered in later stories).
- Password complexity beyond min length not enforced; aligns with current validators.

QA By: QA Agent
Date: 2025-09-14

2025-09-18 – Additional risk/traceability captured in `docs/qa/assessments/epic1-story-1.1-1.7-risk-traceability-20250918.md`. Address SEC-1.4 (bcrypt strength) and DATA-1.4 (duplicate handling) prior to release.
