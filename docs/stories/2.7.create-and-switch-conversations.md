# Story 2.7: Create & Switch Conversations

## Status
Approved

## Story
As a user, I want to create new conversations and switch between them, so I can keep topics separated and return to them later.

## Context
This story implements the core lifecycle of a conversation. It involves creating the database schema to store conversations, building the API endpoints to manage them (create, list, rename), and wiring up the sidebar UI to allow users to create new chats, see their chat history, and switch between them. This is a foundational feature for making the chat application persistent and multi-threaded.

## Acceptance Criteria
1. Authenticated routes exist at `GET /api/conversations`, `POST /api/conversations`, and `PATCH /api/conversations/{id}`; all require a valid NextAuth session and return 401 otherwise. Creating without a title defaults to "Untitled conversation".
2. Conversations are persisted in Neon Postgres via Drizzle ORM with fields `id`, `userId`, `title`, `createdAt`, `updatedAt`, and responses sort by latest `updatedAt` so recent threads appear first.
3. The sidebar "New conversation" button calls the POST endpoint, prepends the returned conversation locally, navigates to `/dashboard?conversation={id}`, and fires a confirmation toast.
4. The sidebar renders the user's conversations with recency badges (Today/Yesterday/date) and highlights the entry matching the `conversation` query parameter.
5. Users can rename conversations via a dialog that calls `PATCH /api/conversations/{id}` with a trimmed title; success updates the local list and shows a toast, while blank titles are rejected with a validation error toast.
6. Security & errors: unauthorized requests receive 401, invalid rename payloads return 400, and unknown conversation IDs return 404; UI surfaces errors without breaking the sidebar.
7. Tests: unit/integration coverage ensures auth gating, creation/list ordering, rename success/error paths, plus a UI test covering new conversation creation, navigation, and rename feedback.

## Tasks / Subtasks
- [ ] Database Schema (AC: 1–2)
  - [ ] Add Drizzle schema: `apps/web/db/schema/conversations.ts` (tables: `conversations`, `messages`).
  - [ ] Ensure `updatedAt` is maintained for sorting (use triggers or application logic).
- [ ] API Routes (AC: 1, 5–6)
  - [ ] Add `apps/web/app/api/conversations/route.ts` (GET, POST) with session enforcement and default title fallback.
  - [ ] Add `apps/web/app/api/conversations/[id]/route.ts` (PATCH) to handle rename with validation and ownership checks.
- [ ] Sidebar UX (AC: 3–4)
  - [ ] Wire sidebar button in `apps/web/components/dashboard/sidebar.tsx` to create and navigate to the new conversation.
  - [ ] Render recency badges (Today/Yesterday/date) for each conversation entry.
  - [ ] Highlight the active conversation using the `conversation` query param.
  - [ ] Surface creation success toast and graceful error toasts.
- [ ] Rename UX (AC: 5–6)
  - [ ] Implement rename dialog component that trims input, enforces non-empty titles, and calls PATCH endpoint.
  - [ ] Show success toast on rename and validation error toast on blanks.
  - [ ] Handle backend errors (404/500) with non-blocking UI messaging.
- [ ] Testing (AC: 7)
  - [ ] API tests for GET/POST/PATCH covering auth gating, default title, and error cases.
  - [ ] UI test covering new conversation creation, navigation, recency badges, and rename success/error flows.
- [ ] Documentation & Migrations
  - [ ] Run migrations against Neon: `pnpm -C apps/web drizzle:generate && pnpm -C apps/web drizzle:migrate`.
  - [ ] Update README with conversation management endpoints and migration instructions.

## Dev Notes
- Requires env var `DATABASE_URL` and valid NextAuth session for API access.
- Recency badges can reuse date-fns formatting utilities; ensure locale consistency.
- Toast messaging should reuse the global notification system used elsewhere (e.g., shadcn `useToast`).
- Keep optimistic UI updates in sync with server responses; revert changes if API fails.
- Message persistence is defined in the architecture and will be hooked up during streaming/story 2.3+ implementation.

## Scrum Master Notes
- This story has a wide scope, touching the database, multiple API endpoints, and several UI components. Ensure tasks are tackled sequentially.
- The database migration is a critical step that must be run and verified.

## Testing
- Manual
  - Log in, open the sidebar, click "New conversation" → verify toast, navigation to `?conversation={id}`, and new entry at top with "Today" badge.
  - Rename a conversation → success toast, title updates everywhere, blank title shows validation error toast.
  - Trigger API errors (network/offline) → verify sidebar remains functional and toasts surface issues.
  - Call APIs without a session → confirm 401 responses.
- Automated
  - API tests covering GET/POST/PATCH auth gating, default titles, rename validation, and error paths.
  - UI test (Playwright or RTL) covering create, navigation, badge rendering, and rename success/error feedback.

## QA Results
TBD

## PO Validation
PO Review Date: 2025-09-17
Decision: PASS
Validation Summary:
- Alignment with PRD Epic 2 confirmed. This story implements the core conversation management features, including persistence, API endpoints, and UI integration.
- Acceptance criteria are comprehensive, testable, and cover all aspects of conversation creation, listing, and renaming.
- Tasks are well-defined and logically sequenced, including database schema, API routes, and UI/UX.
- Security and error handling are explicitly addressed in the acceptance criteria and tasks.

## Dev Agent Record
- **Agent Model Used:** TBD
- **Debug Log References:** TBD
- **Completion Notes List:** TBD
- **File List:** TBD

## Change Log
- 2025-09-16: Implemented conversation create/list API, wired sidebar new conversation, added DB schema.
- 2025-09-17: Updated acceptance criteria for rename flow, recency badges, and toast UX per PRD v4.
- 2025-09-17: Completed story structure and set status to Draft. | SM
| 2025-09-17 | 1.1 | PO Validation and approval. | PO |
