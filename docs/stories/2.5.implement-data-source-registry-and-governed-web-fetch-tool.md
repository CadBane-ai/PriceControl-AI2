# Story 2.5: Implement Data Source Registry & Governed `web.fetch` Tool

## Status: Approved

## Story
* **As a** developer,
* **I want** to create the data governance layer and a secure web-fetching tool,
* **so that** all LLM internet access is strictly controlled and transparent.

## Context
This story is a critical backend and security feature. It establishes the foundation for data governance by creating a registry of approved data sources. It then introduces the first governed tool, `web.fetch`, which allows the LLM to access external websites only if they are on the approved list. This prevents the LLM from accessing arbitrary URLs and ensures all data inputs are transparent and auditable.

## Acceptance Criteria
1.  A `/datasources.yml` file is created at the project root and is parsable by the backend, containing a list of approved data sources.
2.  A server-side guard function (e.g., `isAllowedSource`) is implemented that returns `true` if a given source ID is in the registry and `false` otherwise.
3.  An LLM tool named `web.fetch` is created and made available to the AI.
4.  The `web.fetch` tool, before accessing any URL, MUST call the `isAllowedSource` guard function to verify the source is on the allow-list.
5.  The tool successfully fetches and returns content when given an ID for an allowed source.
6.  The tool returns a structured error message and does NOT make a network request when given an ID for a disallowed source.
7.  Automated tests verify the guard function and the tool's behavior with both allowed and disallowed sources.

## Dev Notes

### Data Governance Architecture
*   **Source Registry:** A `datasources.yml` file at the root of the project serves as the master source registry for the AI. [Source: `docs/architecture/10-unified-project-structure.md`]
*   **Governed Access:** All calls to external financial data APIs must pass through the LLM Gateway Service and be validated against the `datasources.yml` allow-list. [Source: `docs/architecture/7-external-apis.md`]
*   **Transparency Service:** A `Transparency Service` is responsible for parsing and caching the `datasources.yml` file and providing the `isAllowedSource` guard function. [Source: `docs/architecture/6-components.md`]

### Tool Implementation
*   The `web.fetch` tool should be defined within the `LLM Gateway Service`.
*   The tool should accept parameters such as the URL or source ID to fetch.
*   The tool's implementation must call the `isAllowedSource` guard before making any network requests.

## Tasks / Subtasks

-   [ ] **Task 1: Create Data Source Registry** (AC: 1)
    -   [ ] Create a `datasources.yml` file in the project root.
    -   [ ] Define a YAML structure for data sources, including fields like `id`, `name`, `url`, `description`, and `terms_of_service`.
    -   [ ] Add at least two example data sources to the file, one real and one for testing.

-   [ ] **Task 2: Implement Transparency Service** (AC: 2)
    -   [ ] Create a new file `apps/web/lib/governance.ts` for the Transparency Service.
    -   [ ] Implement a function to parse the `datasources.yml` file.
    -   [ ] Implement the `isAllowedSource(sourceId: string): boolean` guard function that checks if a source ID exists in the parsed registry.
    -   [ ] Add caching for the parsed registry to avoid reading the file on every request.

-   [ ] **Task 3: Create `web.fetch` Tool** (AC: 3, 4, 5, 6)
    -   [ ] In the `LLM Gateway Service` (`/api/ai/route.ts` or a helper file), define a new tool named `web.fetch`.
    -   [ ] The tool should take a `sourceId` as a parameter.
    -   [ ] Before fetching, the tool must call `isAllowedSource(sourceId)`.
    -   [ ] If the source is allowed, use a library like `node-fetch` to get the content from the source's URL.
    -   [ ] If the source is not allowed, the tool should return a structured error message (e.g., `{ error: "Source not allowed" }`).
    -   [ ] The tool should handle potential fetching errors gracefully.

-   [ ] **Task 4: Add Tests** (AC: 7)
    -   [ ] Add a unit test for the `isAllowedSource` function to verify it correctly identifies allowed and disallowed sources.
    -   [ ] Add an integration test for the `web.fetch` tool to verify:
        -   It successfully fetches content from an allowed source.
        -   It returns an error for a disallowed source.
        -   It does not make a network request for a disallowed source.

## Scrum Master Notes
- This is a backend-only story. No UI changes are expected.
- This story is a prerequisite for Story 2.6, which integrates the tool with the LLM.

## Testing
- **Manual:**
  - This is a backend feature, so manual testing involves calling the `/api/ai` endpoint with a prompt that would trigger the `web.fetch` tool (once integrated in 2.6).
  - For this story, manual testing is limited to verifying the automated tests pass and reviewing the code for correctness.
- **Automated:**
  - All tests outlined in Task 4 should pass.

## QA Results
TBD

## PO Validation
PO Review Date: 2025-09-17
Decision: PASS
Validation Summary:
- Alignment with PRD Epic 2 confirmed. This story establishes critical data governance for LLM internet access.
- The acceptance criteria are clear, testable, and cover the core functionality and security aspects.
- Tasks are well-defined and logically sequenced.
- This story is a prerequisite for Story 2.6, ensuring a controlled and transparent approach to external data fetching.

## Dev Agent Record
- **Agent Model Used:** TBD
- **Debug Log References:** TBD
- **Completion Notes List:** TBD
- **File List:** TBD

## Change Log
| Date | Version | Description | Author |
|---|---|---|---|
| 2025-09-17 | 1.0 | Initial draft by PO. | PO |
| 2025-09-17 | 1.1 | Completed story structure and added context. | SM |
| 2025-09-17 | 1.2 | PO Validation and approval. | PO |
