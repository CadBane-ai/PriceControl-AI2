# Story 2.5: Implement Data Source Registry & Governed OpenRouter Web Search

## Status: Approved

## Story
* **As a** developer,
* **I want** to create the data governance layer and wire up OpenRouter's native web search plugin,
* **so that** all LLM internet access is strictly controlled and transparent.

## Context
This story is a critical backend and security feature. It establishes the foundation for data governance by creating a registry of approved data sources and configuring OpenRouter's built-in `web` plugin (documented in the [OpenRouter Web Search guide](https://openrouter.ai/docs/features/web-search)). Instead of a bespoke tool, the platform now enables web access by adding `plugins: [{ "id": "web", ... }]` and optional `web_search_options` to chat completions requests. The governance layer must filter the returned search snippets so the LLM only ingests content from allow-listed domains, preventing arbitrary URLs and keeping all external data inputs auditable.

## Acceptance Criteria
1.  A `/datasources.yml` file is created at the project root, is parsable by the backend, and enumerates allow-listed domains with descriptive metadata.
2.  A server-side guard function (e.g., `isAllowedSource`) validates requested source IDs and domains against the registry and exposes helpers for mapping OpenRouter search results back to registry entries.
3.  The `/api/ai/route.ts` pipeline enables OpenRouter's `web` plugin by adding it to the request `plugins` array and respects documented options such as `engine`, `max_results`, `search_prompt`, and `web_search_options.search_context_size`.
4.  Web search responses are filtered so only results originating from allow-listed domains are returned to downstream callers; disallowed domains yield a structured denial with no snippets forwarded to the LLM.
5.  When allowed results exist, the service emits normalized metadata (source ID, title, URL, snippet) suitable for Story 2.6 to cite.
6.  Access denials and successful plugin invocations are logged for auditing, including which domains were allowed or rejected.
7.  Automated tests verify the guard logic, allowed/disallowed result handling, and error logging behavior.

## Dev Notes

### Data Governance Architecture
*   **Source Registry:** A `datasources.yml` file at the root of the project serves as the master source registry for the AI. [Source: `docs/architecture/10-unified-project-structure.md`]
*   **Governed Access:** All calls to external financial data APIs must pass through the LLM Gateway Service and be validated against the `datasources.yml` allow-list. [Source: `docs/architecture/7-external-apis.md`]
*   **Transparency Service:** A `Transparency Service` is responsible for parsing and caching the `datasources.yml` file and providing the `isAllowedSource` guard function. [Source: `docs/architecture/6-components.md`]

### OpenRouter Web Plugin Integration
*   Enable the plugin by passing `plugins: [{ "id": "web", "engine": "native" | "exa", "max_results": n, "search_prompt": string }]` on OpenRouter chat completions requests. [Source: OpenRouter Web Search guide]
*   Support documented options such as `web_search_options.search_context_size` to tune how much context OpenRouter returns.
*   The integration should default to the provider's native engine when available, with an explicit fallback to Exa, and centralize these defaults in configuration.
*   After receiving search results, normalize each entry (title, URL, snippet, domain) and run it through the governance guard before surfacing it to the LLM.

## Tasks / Subtasks

-   [ ] **Task 1: Create Data Source Registry** (AC: 1)
    -   [ ] Create a `datasources.yml` file in the project root.
    -   [ ] Define a YAML structure for data sources, including fields like `id`, `name`, `domain`, `url`, `description`, and `terms_of_service`.
    -   [ ] Add at least two example data sources to the file, one real and one for testing.

-   [ ] **Task 2: Implement Transparency Service** (AC: 2)
    -   [ ] Create a new file `apps/web/lib/governance.ts` for the Transparency Service.
    -   [ ] Implement a function to parse the `datasources.yml` file.
    -   [ ] Implement the `isAllowedSource(sourceId: string): boolean` guard function that checks if a source ID exists in the parsed registry and expose a helper to resolve a domain or URL back to a registry entry.
    -   [ ] Add caching for the parsed registry to avoid reading the file on every request and provide a cache-busting strategy for future updates.

-   [ ] **Task 3: Integrate OpenRouter Web Plugin** (AC: 3, 4, 5, 6)
    -   [ ] In the LLM Gateway (`/api/ai/route.ts` or a helper), centralize the request payload builder so it can append the `web` plugin configuration (engine, `max_results`, `search_prompt`).
    -   [ ] Support `web_search_options.search_context_size` and default it according to product guidance, exposing overrides via environment/config.
    -   [ ] Normalize OpenRouter search results (title, URL, snippet, domain) and filter them through the governance layer, discarding disallowed domains before they reach the LLM.
    -   [ ] Return structured responses for both success (allowed sources) and denial (disallowed domain), including audit-friendly metadata and error codes/logs.

-   [ ] **Task 4: Add Tests** (AC: 7)
    -   [ ] Add unit tests for the governance helpers to verify allowed and disallowed source resolution (by ID and domain).
    -   [ ] Add integration tests around the OpenRouter web plugin wrapper to verify:
        -   Allowed results are surfaced with normalized metadata and audit logs.
        -   Disallowed domains produce structured denial responses without forwarding snippets to the LLM.
        -   Logging and metrics capture both allow and deny events.

## Scrum Master Notes
- This is a backend-only story. No UI changes are expected.
- This story is a prerequisite for Story 2.6, which integrates the tool with the LLM.

## Testing
- **Manual:**
  - This is a backend feature, so manual testing involves calling the `/api/ai` endpoint with a prompt that triggers the OpenRouter `web` plugin (once wired in Story 2.6) and confirming only allow-listed domains appear.
  - For this story, manual testing is limited to verifying the automated tests pass and reviewing the audit logs for correct allow/deny entries.
- **Automated:**
  - All tests outlined in Task 4 should pass.

## QA Results
- **2025-09-18 Risk Profile:** Residual risk moderate (68/100); high-severity items demand ID-only inputs and redirect revalidation. Full analysis in `docs/qa/assessments/2.5-risk-20250918.md`.
- **2025-09-18 Test Design:** 12 scenarios (7 P0, 4 P1, 1 P2) spanning guard unit logic, redirect handling, cache refresh, and audit logging. Matrix: `docs/qa/assessments/2.5-test-design-20250918.md`.
- **QA Focus:** Lock down raw URL payloads, re-validate redirects, and emit structured audit logs for denied attempts prior to release.

## PO Validation
PO Review Date: 2025-09-17
Decision: PASS
Validation Summary:
- Alignment with PRD Epic 2 confirmed. This story establishes critical data governance for LLM internet access.
- The acceptance criteria are clear, testable, and cover the core functionality and security aspects.
- Tasks are well-defined and logically sequenced.
- This story is a prerequisite for Story 2.6, ensuring a controlled and transparent approach to external data fetching.

## Dev Agent Record
- **Agent Model Used:** TBD
- **Debug Log References:** TBD
- **Completion Notes List:** TBD
- **File List:** TBD

## Change Log
| Date | Version | Description | Author |
|---|---|---|---|
| 2025-09-17 | 1.0 | Initial draft by PO. | PO |
| 2025-09-17 | 1.1 | Completed story structure and added context. | SM |
| 2025-09-18 | 1.3 | Updated story to use OpenRouter web search plugin governance. | PM |
| 2025-09-17 | 1.2 | PO Validation and approval. | PO |
