# Story 2.4: Implement Dual-Model Selection

## Status: Approved

## Story
* **As a** user,
* **I want** to be able to choose between a fast model and a more powerful reasoning model,
* **so that** I can use the right tool for the job.

## Context
This story introduces a user-facing control to switch between different LLM models. This allows users to select the appropriate model for their needs (e.g., a faster model for quick queries vs. a more powerful one for complex reasoning). This feature requires updating both the frontend to include the selection UI and the backend to process the user's choice and route the request to the correct model via OpenRouter.

## Acceptance Criteria
1.  A model picker dropdown is added to the chat header.
2.  The picker is populated from a central configuration (`OPENROUTER_MODEL_GROUPS`) and visually groups models (e.g., "Instruct Models", "Reasoning Models").
3.  The UI clearly indicates the currently active model and provides tooltips explaining the model differences.
4.  The user's selection is passed as `model` and `mode` parameters to the `/api/ai` endpoint with each request.
5.  The backend API (`/api/ai/route.ts`) correctly uses the `model` or `mode` parameter to call the specified model via OpenRouter, while still enforcing the Cerebras provider constraint.
6.  The existing authentication on the `/api/ai` endpoint remains enforced.
7.  Automated tests are added to verify the model selection logic on both the frontend and backend.

## Dev Notes

### Model Management Architecture
*   **Configuration:** Frontend model configuration lives in `apps/web/lib/models.ts`. This is where `OPENROUTER_MODEL_GROUPS` and `OPENROUTER_MODELS` are defined. [Source: `docs/architecture/19-model-management.md`]
*   **ModelOption Shape:** `{ id, label, description?, tooltip?, mode? }`
*   **ModelGroup Shape:** `{ key, label, options: ModelOption[] }`
*   **Backend API:** The `/api/ai` route accepts `model` (string) and `mode` (optional `instruct` | `reasoning`) in the request body. If `model` is omitted, the server uses `resolveModelForMode(mode)`. [Source: `docs/architecture/5-api-specification.md`, `docs/architecture/19-model-management.md`]
*   **Provider Constraint:** The server calls OpenRouter with `{ provider: { only: ["Cerebras"] } }` to ensure Cerebras is the execution provider. [Source: `docs/architecture/19-model-management.md`]

### UI Implementation
*   The model picker should be a dropdown menu in the chat header.
*   It should be populated from the `OPENROUTER_MODEL_GROUPS` configuration.
*   The picker should default to the `instruct` model.
*   The UI should clearly indicate the currently selected model.
*   Use components from `shadcn/ui` for the dropdown. [Source: `docs/architecture/3-tech-stack.md`]

## Tasks / Subtasks

-   [ ] **Task 1: Create Model Configuration** (AC: 2)
    -   [ ] Create `apps/web/lib/models.ts`.
    -   [ ] Define `ModelOption` and `ModelGroup` types.
    -   [ ] Create `OPENROUTER_MODEL_GROUPS` array with at least two groups (e.g., "Instruct" and "Reasoning").
    -   [ ] Populate groups with `ModelOption` objects for the Cerebras models listed in `19-model-management.md`.
    -   [ ] Define `OPENROUTER_MODELS` with default `instruct` and `reasoning` model IDs.
    -   [ ] Implement `resolveModelForMode` and `findOptionById` helper functions.

-   [ ] **Task 2: Implement Frontend Model Picker** (AC: 1, 3)
    -   [ ] Create a new component `ModelPicker.tsx` in `apps/web/components/`.
    -   [ ] Use `shadcn/ui` DropdownMenu to build the picker.
    -   [ ] Populate the dropdown from `OPENROUTER_MODEL_GROUPS`.
    -   [ ] Manage the selected model ID in client-side state (e.g., Zustand).
    -   [ ] Display the currently selected model's label in the chat header.
    -   [ ] Add tooltips to explain the trade-offs between models.

-   [ ] **Task 3: Update Frontend Chat Logic** (AC: 4)
    -   [ ] In the chat component, retrieve the selected `model` and `mode` from state.
    -   [ ] Pass the `model` and `mode` in the body of the POST request to `/api/ai`.

-   [ ] **Task 4: Update Backend API Route** (AC: 5, 6)
    -   [ ] In `/api/ai/route.ts`, read the `model` and `mode` from the request body.
    -   [ ] If `model` is provided, use it. If not, use `resolveModelForMode(mode)` to get the default.
    -   [ ] Pass the selected model ID to the OpenRouter API call.
    -   [ ] Ensure the `{ provider: { only: ["Cerebras"] } }` constraint is included in the OpenRouter call.
    -   [ ] Verify NextAuth session check remains in place.

-   [ ] **Task 5: Add Tests** (AC: 7)
    -   [ ] Add a unit test for the `resolveModelForMode` helper function.
    -   [ ] Add a component test for the `ModelPicker` to verify it renders options correctly and updates state on selection. [Source: `docs/architecture/14-testing-strategy.md`]
    -   [ ] Add an integration test for the `/api/ai` endpoint to verify it correctly selects the model based on the `model` and `mode` parameters.

## Scrum Master Notes
- This story has both frontend and backend components that need to be coordinated.
- Ensure the model configuration in `apps/web/lib/models.ts` is treated as the single source of truth for the UI.

## Testing
- **Manual:**
  - Verify the model picker dropdown appears in the chat header.
  - Verify it is populated with the correct model groups and options from the configuration.
  - Select a model and confirm the UI updates to show the current selection.
  - Send a chat message and verify in the browser's network tab that the `model` and `mode` are sent in the request to `/api/ai`.
  - Verify the response comes from the selected model (may require checking backend logs).
- **Automated:**
  - All tests outlined in Task 5 should pass.

## QA Results
TBD

## PO Validation
TBD

## Dev Agent Record
- **Agent Model Used:** TBD
- **Debug Log References:** TBD
- **Completion Notes List:** TBD
- **File List:** TBD

## Change Log
| Date | Version | Description | Author |
|---|---|---|---|
| 2025-09-17 | 1.0 | Initial draft by PO. | PO |
| 2025-09-17 | 1.1 | Completed story structure, added context, and expanded ACs. | SM |
