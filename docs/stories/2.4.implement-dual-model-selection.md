# Story 2.4: Implement Dual-Model Selection

## Status: Ready for Review

## Story
* **As a** user,
* **I want** to be able to choose between a fast model and a more powerful reasoning model,
* **so that** I can use the right tool for the job.

## Context
This story introduces a user-facing control to switch between different LLM models. This allows users to select the appropriate model for their needs (e.g., a faster model for quick queries vs. a more powerful one for complex reasoning). This feature requires updating both the frontend to include the selection UI and the backend to process the user's choice and route the request to the correct model via OpenRouter.

## Acceptance Criteria
1.  A model picker dropdown is added to the chat header.
2.  The picker is populated from a central configuration (`OPENROUTER_MODEL_GROUPS`) and visually groups models (e.g., "Instruct Models", "Reasoning Models").
3.  The UI clearly indicates the currently active model and provides tooltips explaining the model differences.
4.  The user's selection is passed as `model` and `mode` parameters to the `/api/ai` endpoint with each request.
5.  The backend API (`/api/ai/route.ts`) correctly uses the `model` or `mode` parameter to call the specified model via OpenRouter, while still enforcing the Cerebras provider constraint.
6.  The existing authentication on the `/api/ai` endpoint remains enforced.
7.  Automated tests are added to verify the model selection logic on both the frontend and backend.

## Dev Notes

### Model Management Architecture
*   **Configuration:** Frontend model configuration lives in `apps/web/lib/models.ts`. This is where `OPENROUTER_MODEL_GROUPS` and `OPENROUTER_MODELS` are defined. [Source: `docs/architecture/19-model-management.md`]
*   **ModelOption Shape:** `{ id, label, description?, tooltip?, mode? }`
*   **ModelGroup Shape:** `{ key, label, options: ModelOption[] }`
*   **Backend API:** The `/api/ai` route accepts `model` (string) and `mode` (optional `instruct` | `reasoning`) in the request body. If `model` is omitted, the server uses `resolveModelForMode(mode)`. [Source: `docs/architecture/5-api-specification.md`, `docs/architecture/19-model-management.md`]
*   **Provider Constraint:** The server calls OpenRouter with `{ provider: { only: ["Cerebras"] } }` to ensure Cerebras is the execution provider. [Source: `docs/architecture/19-model-management.md`]

### UI Implementation
*   The model picker should be a dropdown menu in the chat header.
*   It should be populated from the `OPENROUTER_MODEL_GROUPS` configuration.
*   The picker should default to the `instruct` model.
*   The UI should clearly indicate the currently selected model.
*   Use components from `shadcn/ui` for the dropdown. [Source: `docs/architecture/3-tech-stack.md`]

## Tasks / Subtasks

-   [x] **Task 1: Create Model Configuration** (AC: 2)
    -   [x] Create `apps/web/lib/models.ts`.
    -   [x] Define `ModelOption` and `ModelGroup` types.
    -   [x] Create `OPENROUTER_MODEL_GROUPS` array with at least two groups (e.g., "Instruct" and "Reasoning").
    -   [x] Populate groups with `ModelOption` objects for the Cerebras models listed in `19-model-management.md`.
    -   [x] Define `OPENROUTER_MODELS` with default `instruct` and `reasoning` model IDs.
    -   [x] Implement `resolveModelForMode` and `findOptionById` helper functions.

-   [x] **Task 2: Implement Frontend Model Picker** (AC: 1, 3)
    -   [x] Create a new component `ModelPicker.tsx` in `apps/web/components/`.
    -   [x] Use `shadcn/ui` DropdownMenu to build the picker.
    -   [x] Populate the dropdown from `OPENROUTER_MODEL_GROUPS`.
    -   [x] Manage the selected model ID in client-side state (e.g., Zustand).
    -   [x] Display the currently selected model's label in the chat header.
    -   [x] Add tooltips to explain the trade-offs between models.

-   [x] **Task 3: Update Frontend Chat Logic** (AC: 4)
    -   [x] In the chat component, retrieve the selected `model` and `mode` from state.
    -   [x] Pass the `model` and `mode` in the body of the POST request to `/api/ai`.

-   [x] **Task 4: Update Backend API Route** (AC: 5, 6)
    -   [x] In `/api/ai/route.ts`, read the `model` and `mode` from the request body.
    -   [x] If `model` is provided, use it. If not, use `resolveModelForMode(mode)` to get the default.
    -   [x] Pass the selected model ID to the OpenRouter API call.
    -   [x] Ensure the `{ provider: { only: ["Cerebras"] } }` constraint is included in the OpenRouter call.
    -   [x] Verify NextAuth session check remains in place.

-   [x] **Task 5: Add Tests** (AC: 7)
    -   [x] Add a unit test for the `resolveModelForMode` helper function.
    -   [x] Add a component test for the `ModelPicker` to verify it renders options correctly and updates state on selection. [Source: `docs/architecture/14-testing-strategy.md`]
    -   [x] Add an integration test for the `/api/ai` endpoint to verify it correctly selects the model based on the `model` and `mode` parameters.

## Scrum Master Notes
- This story has both frontend and backend components that need to be coordinated.
- Ensure the model configuration in `apps/web/lib/models.ts` is treated as the single source of truth for the UI.

## Testing
- **Manual:**
  - Verify the model picker dropdown appears in the chat header.
  - Verify it is populated with the correct model groups and options from the configuration.
  - Select a model and confirm the UI updates to show the current selection.
  - Send a chat message and verify in the browser's network tab that the `model` and `mode` are sent in the request to `/api/ai`.
  - Verify the response comes from the selected model (may require checking backend logs).
- **Automated:**
  - All tests outlined in Task 5 should pass.

## QA Results

### Review Date: 2025-09-18

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment
Frontend state is cleanly scoped to `DashboardPage`, keeping the picker logic localized while still passing the chosen `model`/`mode` through `useChat`. Backend updates honour the Cerebras-only constraint and now reject unknown or mismatched model IDs up front. Helper utilities in `apps/web/lib/models.ts` centralize lookup/inference, improving maintainability for any future model additions.

### Compliance Check
- Coding Standards: [✓]
- Project Structure: [✓]
- Testing Strategy: [✓]
- All ACs Met: [✓]

### Test & Coverage Notes
- `apps/web/__tests__/model-picker.test.tsx` exercises the dropdown UX and verifies the active selection label/mode (AC1–AC3).
- `apps/web/__tests__/chat-usechat-integration.test.tsx` confirms chat requests forward the selected `model`/`mode`, including reasoning selections (AC4).
- `apps/web/__tests__/api-ai-route.test.ts` guards backend validation, Cerebras enforcement, and unknown-model rejection (AC5 & AC6).
- `apps/web/__tests__/models-config.test.ts` validates configuration defaults and lookup helpers (supports AC2 & AC7).
- Existing chat logic tests updated to tolerate the picker stub and continue verifying message handling (AC7).

### Observations & Follow-ups
- Consider adding lightweight telemetry in a future story to record model usage patterns server-side (ties back to OPS-001 mitigation), but not gating for this release.

### Gate Status
Gate: PASS → qa/gates/2.4-implement-dual-model-selection.yml

## PO Validation
TBD

## Dev Agent Record
- **Agent Model Used:** GPT-5 Codex
- **Debug Log References:** None
- **Completion Notes List:**
  - Added shared OpenRouter configuration helpers plus lookup/index support for validation and inference.
  - Introduced dropdown-based `ModelPicker` with tooltip-rich grouping, wired into dashboard chat header state.
  - Updated `/api/ai` pipeline to validate incoming models, enforce Cerebras constraint, and persist mode metadata.
  - Expanded automated coverage for configuration, picker interactions, useChat integration, and API routing outcomes.
- **File List:**
  - apps/web/lib/models.ts
  - apps/web/app/(protected)/dashboard/page.tsx
  - apps/web/components/chat/model-picker.tsx
  - apps/web/app/api/ai/route.ts
  - apps/web/lib/validators.ts
  - apps/web/__tests__/models-config.test.ts
  - apps/web/__tests__/model-picker.test.tsx
  - apps/web/__tests__/chat-usechat-integration.test.tsx
  - apps/web/__tests__/chat-frontend-logic.test.tsx
  - apps/web/__tests__/api-ai-route.test.ts

## Change Log
| Date | Version | Description | Author |
|---|---|---|---|
| 2025-09-18 | 1.2 | Implemented dual-model selection UI/state, backend validation, and automated tests. | Dev |

## Change Log
| Date | Version | Description | Author |
|---|---|---|---|
| 2025-09-17 | 1.0 | Initial draft by PO. | PO |
| 2025-09-17 | 1.1 | Completed story structure, added context, and expanded ACs. | SM |
