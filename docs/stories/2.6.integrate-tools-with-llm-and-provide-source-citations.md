# Story 2.6: Integrate Tools with LLM and Provide Source Citations

## Status: Approved

## Story
* **As a** user,
* **I want** to see where the AI got its information from,
* **so that** I can trust and verify its answers.

## Context
This story connects the `web.fetch` tool (from Story 2.5) to the LLM and teaches the LLM how to use it. It involves creating a system prompt to guide the AI, enabling the tool in the API, auditing its usage, and updating the frontend to display the resulting source citations. This is a key step in building a trustworthy, transparent AI assistant.

## Acceptance Criteria
1.  The `web.fetch` tool is made available to the LLM in the `/api/ai/route.ts` endpoint.
2.  A system prompt is loaded from a `/prompts/*.mdx` file and used in the LLM call, instructing the AI to use its tools and cite sources in a specified format.
3.  When asked a question that requires current data, the LLM correctly uses the `web.fetch` tool to get information.
4.  Every call to an LLM tool is recorded in a `ToolCallLog` in the database for auditing purposes.
5.  The final response streamed to the user includes a clear, clickable citation of the source that was used to generate the answer.

## Dev Notes

### LLM Gateway Architecture
*   **Tool Integration:** The `LLM Gateway Service` is responsible for defining and providing tools to the LLM. [Source: `docs/architecture/6-components.md`]
*   **System Prompts:** System prompts are loaded from the `/prompts/` directory. [Source: `docs/architecture/10-unified-project-structure.md`]
*   **Audit Trail:** The `ToolCallLog` data model should be used to create an immutable audit trail of every tool call. [Source: `docs/architecture/4-data-models.md`]

### Citation Implementation
*   The system prompt should instruct the LLM to output a special token or formatted string for citations (e.g., `[Source: a-source-id]`).
*   The frontend chat component should be updated to recognize and format these citations as clickable links.

## Tasks / Subtasks

-   [ ] **Task 1: Integrate `web.fetch` Tool with LLM** (AC: 1)
    -   [ ] In `/api/ai/route.ts`, import the `web.fetch` tool definition.
    -   [ ] Pass the `web.fetch` tool to the `streamText` call from the Vercel AI SDK (or equivalent LLM provider call).

-   [ ] **Task 2: Create and Load System Prompt** (AC: 2)
    -   [ ] Create a new file `prompts/base-system.mdx`.
    -   [ ] Write a system prompt that instructs the LLM on its persona, capabilities, and how to use tools.
    -   [ ] Crucially, the prompt must instruct the LLM to cite its sources using a specific format (e.g., `[Source: source-id]`) after providing information obtained from a tool.
    -   [ ] In `/api/ai/route.ts`, read the content of `prompts/base-system.mdx` and include it as the system message in the LLM request.

-   [ ] **Task 3: Implement Tool Call Auditing** (AC: 4)
    -   [ ] In the `LLM Gateway Service`, after a tool is called, create a new `ToolCallLog` entry in the database.
    -   [ ] The log entry should include the `conversationId`, `toolName`, `toolInput`, and `status` (`success` or `failure`).

-   [ ] **Task 4: Update Frontend for Citations** (AC: 5)
    -   [ ] In the frontend chat message component, add logic to parse the AI's response for citation tokens (e.g., `[Source: ...]`).
    -   [ ] Replace the citation token with a formatted, clickable link.
    -   [ ] The link should point to the source's URL, which can be retrieved from the `datasources.yml` file (this may require a new API endpoint or passing the source info along with the chat response).

-   [ ] **Task 5: Add Tests** (AC: 3, 4, 5)
    -   [ ] Add an integration test for the `/api/ai` endpoint that sends a query requiring web access.
    -   [ ] The test should assert that the `web.fetch` tool is called.
    -   [ ] The test should assert that a `ToolCallLog` entry is created.
    -   [ ] The test should assert that the final streamed response contains a citation.

## Scrum Master Notes
- This story has dependencies on Story 2.5 (for the `web.fetch` tool) and requires both backend and frontend changes.
- The format of the citation token (e.g., `[Source: id]`) should be standardized and documented.

## Testing
- **Manual:**
  - Ask the AI a question that requires information from one of the allowed data sources (e.g., "What is the latest news from source X?").
  - Verify the AI response contains the information and a clickable citation link.
  - Click the citation link and verify it navigates to the correct source URL.
  - Check the `ToolCallLog` table in the database to ensure the tool call was recorded.
- **Automated:**
  - All tests outlined in Task 5 should pass.

## QA Results
TBD

## PO Validation
PO Review Date: 2025-09-17
Decision: PASS
Validation Summary:
- Alignment with PRD Epic 2 confirmed. This story integrates the `web.fetch` tool and implements source citations, enhancing transparency and trustworthiness.
- Acceptance criteria are clear, testable, and cover tool integration, system prompting, auditing, and frontend display.
- Tasks are well-defined and logically sequenced.
- This story builds directly on Story 2.5, ensuring a controlled and auditable approach to LLM external access.

## Dev Agent Record
- **Agent Model Used:** TBD
- **Debug Log References:** TBD
- **Completion Notes List:** TBD
- **File List:** TBD

## Change Log
| Date | Version | Description | Author |
|---|---|---|---|
| 2025-09-17 | 1.0 | Initial draft by PO. | PO |
| 2025-09-17 | 1.1 | Completed story structure, added context, and aligned ACs with tasks. | SM |
| 2025-09-17 | 1.2 | PO Validation and approval. | PO |
