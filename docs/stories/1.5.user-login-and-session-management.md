# Story 1.5: User Login & Session Management

## Status
Review

## Story
**As a** developer,
**I want** to implement secure login and session management,
**so that** existing users can authenticate and establish a session.

## Acceptance Criteria
1. NextAuth (Auth.js) is configured with a Credentials provider and JWT session strategy.
2. NextAuth route handlers are exposed at `/api/auth/[...nextauth]` (GET/POST).
3. Clients authenticate via the NextAuth Credentials flow (e.g., `signIn('credentials', { email, password, redirect: false })` or form POST to `/api/auth/callback/credentials`), and on success receive a session cookie; invalid credentials return 401.
4. An auxiliary `/api/auth/login` endpoint exists and either:
   - returns guidance instructing clients to use the NextAuth Credentials flow; or
   - redirects (307) to `/api/auth/callback/credentials` with a form-encoded body so NextAuth issues cookies.
   Either behavior is acceptable.

## Tasks / Subtasks
- [x] Dependencies & Setup
  - [x] Install and configure `next-auth` (Auth.js) in `apps/web`.
  - [x] Add environment requirements: `NEXTAUTH_SECRET`, `NEXTAUTH_URL` (document only; no secrets committed).
- [x] Auth Configuration
  - [x] Create `apps/web/lib/auth.ts` configuring NextAuth with:
    - [x] Credentials provider that validates email/password using Drizzle and `bcryptjs.compare`.
    - [x] Google OAuth provider behind env (optional for now; enabled when keys exist).
  - [x] Set session strategy (JWT) and callbacks to include `user.id` and `email` in token/session.
- [x] Auth Route Handler
  - [x] Add `apps/web/app/api/auth/[...nextauth]/route.ts` exporting NextAuth `GET`/`POST` handlers.
- [x] Login API
  - [x] Implement `apps/web/app/api/auth/login/route.ts` (POST):
    - [x] Validate input (reuse Zod schema).
    - [x] Provide guidance to use NextAuth Credentials flow for session cookies (signIn('credentials') or POST to callback).
    - [x] Return 200 with instructions; invalid input returns 400.
- [x] Documentation
  - [x] Update README with a short section on NextAuth setup, required env vars, and how the login flow works.

## Dev Notes
- Alignment
  - Mirrors PRD Story 1.5 requirements for login and session.
  - Builds on Story 1.2 (DB) and complements Story 1.4 (registration).
  - Route protection and UI wiring occur in Story 1.6.
- Environment
  - `NEXTAUTH_SECRET` and `NEXTAUTH_URL` must be set locally and in Vercel (document only in this story).
- Implementation guidance
  - Credentials provider: lookup user by email via Drizzle, compare `bcrypt` hash, return minimal user object on success.
  - Session: use JWT strategy; include `sub`/`id` and `email` in token for easy access.
  - `/api/auth/login` can 307 redirect to NextAuth’s credentials callback to ensure cookies are set by the browser; for API clients, advise calling `/api/auth/[...nextauth]` using the official flow.
- Security
  - Do not leak whether email exists; return generic invalid credentials message.
  - Rate limiting deferred to later stories (Upstash).

### Testing
- cURL/manual tests:
  - POST `/api/auth/login` with valid credentials → success (and cookie via browser redirect), 401 on invalid.
  - Direct NextAuth credentials call (when wired in UI) will be validated in Story 1.6.
- Verify session decoding via NextAuth `getServerSession` in a temporary test route (optional, not committed).

## Change Log
| Date | Version | Description | Author |
|---|---|---|---|
| 2025-09-14 | 0.1 | Initial draft for login & session story | Scrum Master |
| 2025-09-14 | 0.2 | PO validation complete, status set to Approved; added traceability notes | Product Owner |
| 2025-09-14 | 0.3 | PO revision: Updated AC to specify NextAuth credentials flow as the canonical login path; `/api/auth/login` may guide or redirect | Product Owner |

## Dev Agent Record
### Agent Model Used
{{agent_model_name_version}}

### Debug Log References

### Completion Notes List

- Installed and configured NextAuth v4 with Credentials provider and optional Google provider via env.
- Added JWT session strategy and callbacks to include `id` and `email` in token/session.
- Exposed NextAuth handlers at `/api/auth/[...nextauth]` for GET/POST.
- Added `/api/auth/login` POST endpoint to validate inputs and instruct clients to use NextAuth credentials flow.

### File List

- Added: `apps/web/lib/auth.ts`
- Added: `apps/web/app/api/auth/[...nextauth]/route.ts`
- Added: `apps/web/app/api/auth/login/route.ts`
- Updated: `apps/web/package.json` (add `next-auth`)
- Updated: `apps/web/pnpm-lock.yaml`

- Traceability
  - Aligns with AGENT_HANDOFF.md → Next Steps → (4) Authentication.
  - Mirrors PRD 6-epic-1-foundation-user-onboarding.md → Story 1.5 AC 1–5.
  - Depends on Story 1.2 (DB) and complements Story 1.4 (registration) before Story 1.6 (UI wiring & route protection).
## QA Results
Decision: PASS

Summary
- Revised Acceptance Criteria designate the NextAuth Credentials flow as the canonical login path. Implementation matches this: NextAuth v4 is configured with Credentials provider and JWT sessions, handlers are available at `/api/auth/[...nextauth]`, and the auxiliary `/api/auth/login` returns guidance to use the credentials flow.

Acceptance Criteria Coverage
- AC1: NextAuth configured with Credentials + JWT — PASS.
- AC2: Handlers exposed at `/api/auth/[...nextauth]` — PASS.
- AC3: Clients authenticate via credentials flow and receive session cookies; invalid returns 401 — PASS (handled by NextAuth).
- AC4: Auxiliary `/api/auth/login` exists and returns guidance — PASS.

Manual Validation
- Prereqs: Set `NEXTAUTH_SECRET`, `NEXTAUTH_URL`, `DATABASE_URL`. Have at least one user registered.
- Call `signIn('credentials', { email, password, redirect: false })` from the client or use the NextAuth callback form POST; expect session on success, 401 on invalid.

Notes
- CSRF tokens are managed by NextAuth in its credential callback path; keeping `/api/auth/login` as guidance avoids duplicating that logic.

QA By: QA Agent
Date: 2025-09-14
