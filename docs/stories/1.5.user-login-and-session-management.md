# Story 1.5: User Login & Session Management

## Status
Review

## Story
**As a** developer,
**I want** to implement secure login and session management,
**so that** existing users can authenticate and establish a session.

## Acceptance Criteria
1. NextAuth is configured with a Credentials provider that validates email/password combinations against the Neon database using bcrypt.
2. The NextAuth handler is exposed at `/api/auth/[...nextauth]`, supporting GET/POST, and server routes can consume `getServerSession` for session checks.
3. The helper endpoint at `/api/auth/login` accepts a JSON payload, validates it with zod, and responds with guidance to use the NextAuth Credentials callback.
4. Successful credential sign-in issues a secure session cookie that backend routes rely on; responses never expose sensitive details.
5. Invalid credentials return a generic error message without revealing whether the email exists.
6. When `GOOGLE_CLIENT_ID` and `GOOGLE_CLIENT_SECRET` are set, the Google OAuth provider is registered and surfaced through `GET /api/auth/providers` so the login experience can render the Google button.

## Tasks / Subtasks
- [ ] Dependencies & Setup
  - [ ] Install and configure `next-auth` (Auth.js) in `apps/web`.
  - [ ] Document environment requirements: `NEXTAUTH_SECRET`, `NEXTAUTH_URL`, `DATABASE_URL`, `GOOGLE_CLIENT_ID`, `GOOGLE_CLIENT_SECRET`.
- [ ] Auth Configuration
  - [ ] Create `apps/web/lib/auth.ts` configuring NextAuth with:
    - [ ] Credentials provider validating email/password using Drizzle and `bcryptjs.compare`.
    - [ ] Google OAuth provider guarded behind env credentials (disabled when unset).
  - [ ] Set session strategy (JWT) and callbacks to include `user.id` and `email` in token/session.
  - [ ] Verify `GET /api/auth/providers` surfaces Google when configured and document fallback when absent.
- [ ] Auth Route Handler
  - [ ] Add `apps/web/app/api/auth/[...nextauth]/route.ts` exporting NextAuth `GET`/`POST` handlers.
- [ ] Login Helper Endpoint
  - [ ] Implement `apps/web/app/api/auth/login/route.ts` (POST):
    - [ ] Validate input via shared Zod schema.
    - [ ] Return instructions (or 307 redirect) guiding clients to use the NextAuth Credentials flow so cookies are issued correctly.
    - [ ] Return 400 on invalid payload; never expose whether the email exists.
- [ ] Documentation
  - [ ] Update README with NextAuth setup, required env vars (including Google), and login flow expectations.

## Dev Notes
- Alignment
  - Mirrors PRD Story 1.5 requirements for login and session.
  - Builds on Story 1.2 (DB) and complements Story 1.4 (registration).
  - Route protection and UI wiring occur in Story 1.6.
- Environment
  - `NEXTAUTH_SECRET`, `NEXTAUTH_URL`, `DATABASE_URL`, `GOOGLE_CLIENT_ID`, and `GOOGLE_CLIENT_SECRET` must be set locally and in Vercel (document only in this story).
- Implementation guidance
  - Credentials provider: lookup user by email via Drizzle, compare `bcrypt` hash, return minimal user object on success.
  - Session: use JWT strategy; include `sub`/`id` and `email` in token for easy access.
  - `/api/auth/login` can 307 redirect to NextAuth’s credentials callback to ensure cookies are set by the browser; for API clients, advise calling `/api/auth/[...nextauth]` using the official flow.
  - `GET /api/auth/providers` automatically surfaces configured providers; ensure login UI reads this endpoint so Google appears when env credentials exist.
- Security
  - Do not leak whether email exists; return generic invalid credentials message.
  - Rate limiting deferred to later stories (Upstash).

### Testing
- Manual:
  - POST `/api/auth/login` with valid credentials → success (and cookie via browser redirect), 401 on invalid.
  - Call `GET /api/auth/providers` with and without Google env credentials to verify provider list.
  - Direct NextAuth credentials call (when wired in UI) will be validated in Story 1.6.
- Automated:
  - API route tests mocking session context to verify 401/201/200.
  - Add tests ensuring provider registration logic exposes Google when env keys are set.

## Change Log
| Date | Version | Description | Author |
|---|---|---|---|
| 2025-09-14 | 0.1 | Initial draft for login & session story | Scrum Master |
| 2025-09-14 | 0.2 | PO validation complete, status set to Approved; added traceability notes | Product Owner |
| 2025-09-14 | 0.3 | PO revision: Updated AC to specify NextAuth credentials flow as the canonical login path; `/api/auth/login` may guide or redirect | Product Owner |
| 2025-09-17 | 0.4 | Updated AC for Google provider registration and providers endpoint per PRD/architecture v4 | Product Owner |
| 2025-09-18 | 0.5 | Synced AC wording with PRD v4 Story 1.5 to clarify bcrypt validation and helper endpoint behavior | Scrum Master |

## Dev Agent Record
### Agent Model Used
{{agent_model_name_version}}

### Debug Log References

### Completion Notes List

- Installed and configured NextAuth v4 with Credentials provider and optional Google provider via env.
- Added JWT session strategy and callbacks to include `id` and `email` in token/session.
- Exposed NextAuth handlers at `/api/auth/[...nextauth]` for GET/POST.
- Added `/api/auth/login` POST endpoint to validate inputs and instruct clients to use NextAuth credentials flow.

### File List

- Added: `apps/web/lib/auth.ts`
- Added: `apps/web/app/api/auth/[...nextauth]/route.ts`
- Added: `apps/web/app/api/auth/login/route.ts`
- Updated: `apps/web/package.json` (add `next-auth`)
- Updated: `apps/web/pnpm-lock.yaml`

- Traceability
  - Aligns with AGENT_HANDOFF.md → Next Steps → (4) Authentication.
  - Mirrors PRD `6-epic-1-foundation-user-onboarding.md` → Story 1.5 AC 1–6.
  - Depends on Story 1.2 (DB) and complements Story 1.4 (registration) before Story 1.6 (UI wiring & route protection).
## QA Results
Decision: PASS

Summary
- Revised Acceptance Criteria designate the NextAuth Credentials flow as the canonical login path. Implementation matches this: NextAuth v4 is configured with Credentials provider and JWT sessions, handlers are available at `/api/auth/[...nextauth]`, and the auxiliary `/api/auth/login` returns guidance to use the credentials flow.

Acceptance Criteria Coverage
- AC1: NextAuth configured with Credentials + JWT — PASS.
- AC2: Handlers exposed at `/api/auth/[...nextauth]` — PASS.
- AC3: Clients authenticate via credentials flow and receive session cookies; invalid returns 401 — PASS (handled by NextAuth).
- AC4: Auxiliary `/api/auth/login` exists and returns guidance — PASS.

Manual Validation
- Prereqs: Set `NEXTAUTH_SECRET`, `NEXTAUTH_URL`, `DATABASE_URL`. Have at least one user registered.
- Call `signIn('credentials', { email, password, redirect: false })` from the client or use the NextAuth callback form POST; expect session on success, 401 on invalid.

Notes
- CSRF tokens are managed by NextAuth in its credential callback path; keeping `/api/auth/login` as guidance avoids duplicating that logic.
- Re-validate Google provider surfacing once env credentials are configured (PRD v4 update 2025-09-17).

QA By: QA Agent
Date: 2025-09-14

2025-09-18 – Manual risk matrix and traceability supplement recorded in `docs/qa/assessments/epic1-story-1.1-1.7-risk-traceability-20250918.md`. High attention on SEC-1.5 (session fixation) and TECH-1.5 (provider drift); ensure automated auth regression suite is in place.
